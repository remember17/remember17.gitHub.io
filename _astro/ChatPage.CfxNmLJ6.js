import{w as S,a as O,v as F}from"./runtime-dom.esm-bundler.Cc_N6hud.js";import{_ as y,a as U,c as J,u as C}from"./session-store.Dd2HyGIM.js";import{h as g,i as l,c,a as n,b as d,k as b,d as f,n as w,l as _,t as u,f as p,F as x,m as T,j as I,p as B,w as A,o as N,g as z}from"./pinia.GsotNk0y.js";import{W as L,a as $,g as K,c as H,f as P,e as V,h as W,i as R,j as X,d as Y,k as q,l as E,m as G,C as Q}from"./ws-client.fv07f5cr.js";import{T as Z}from"./ToastHost.CQvuvMz1.js";const ee=p({__name:"ChatHeader",props:{inRoom:{type:Boolean},isOwner:{type:Boolean},showOwnerMenu:{type:Boolean},showChannelDrawer:{type:Boolean},channelTitle:{},memberCount:{}},emits:["toggle-owner-menu","toggle-drawer","open-members","clear-content","close-room-menu","close-room-header","leave-room"],setup(t,{expose:e}){e();const s={};return Object.defineProperty(s,"__isScriptSetup",{enumerable:!1,value:!0}),s}}),te={class:"shrink-0 border-b z-40",style:{"padding-top":"env(safe-area-inset-top)",background:"var(--surface-1)","border-color":"var(--ink-4)"}},oe={class:"h-14 flex items-center justify-between px-4 md:px-6"},se={class:"flex items-center gap-2"},ne={href:"/applications",class:"flex items-center gap-1.5 px-2 py-1.5 rounded-lg text-sm font-medium transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--ink-2)"},"aria-label":"返回应用列表"},re={href:"https://fivehow.com",class:"flex items-center gap-1.5 px-2 py-1.5 rounded-lg text-sm font-medium transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--ink-2)"},"aria-label":"回到主页"},ie={class:"flex items-center gap-2 absolute left-1/2 -translate-x-1/2"},ae={class:"flex items-center gap-2"},le={key:0,class:"relative"},ce={key:0,class:"absolute right-0 top-full mt-1 w-48 rounded-xl border p-1.5 z-50 animate-scale-in",style:{background:"var(--surface-1)","border-color":"var(--ink-4)","box-shadow":"var(--shadow-modal)"}},de={key:1,class:"hidden md:flex items-center px-2 py-1.5 rounded-lg transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--ink-2)"},"aria-label":"搜索"},me={key:0,class:"shrink-0 px-4 md:px-6 py-3 border-t flex items-center justify-between",style:{"border-color":"color-mix(in srgb, var(--ink-4) 50%, transparent)"}},he={class:"flex items-center gap-2 min-w-0"},ue={class:"text-sm font-semibold truncate",style:{color:"var(--ink-0)"}},fe={class:"text-xs shrink-0 px-2 py-0.5 rounded-full",style:{background:"var(--surface-2)",color:"var(--ink-2)"}},ve={class:"flex items-center gap-1"};function we(t,e,s,o,a,m){const i=g("iconify-icon");return l(),c("div",te,[n("div",oe,[n("div",se,[n("a",ne,[d(i,{icon:"lucide:arrow-left",class:"text-base"}),e[7]||(e[7]=n("span",{class:"hidden md:inline"},"应用列表",-1))]),n("a",re,[d(i,{icon:"lucide:home",class:"text-base"}),e[8]||(e[8]=n("span",{class:"hidden md:inline"},"主页",-1))])]),n("div",ie,[d(i,{icon:"lucide:message-circle",class:"text-lg",style:{color:"var(--ink-1)"}}),e[9]||(e[9]=n("span",{class:"text-base font-semibold",style:{color:"var(--ink-0)","font-family":"var(--font-heading)"}},"Chat",-1))]),n("div",ae,[s.isOwner&&s.inRoom?(l(),c("div",le,[n("button",{class:"flex items-center gap-1 px-2 py-1.5 rounded-lg text-sm transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--ink-2)"},"aria-label":"频道管理",onClick:e[0]||(e[0]=r=>t.$emit("toggle-owner-menu"))},[d(i,{icon:"lucide:more-vertical",class:"text-base"})]),s.showOwnerMenu?(l(),c("div",ce,[e[13]||(e[13]=n("div",{class:"px-3 py-1.5 text-xs font-medium",style:{color:"var(--ink-3)"}},"频道管理 (OWNER)",-1)),n("button",{class:"w-full text-left px-3 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--ink-1)"},onClick:e[1]||(e[1]=r=>t.$emit("open-members"))},[d(i,{icon:"lucide:users",class:"text-base"}),e[10]||(e[10]=b(" 管理成员 ",-1))]),n("button",{class:"w-full text-left px-3 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--danger)"},onClick:e[2]||(e[2]=r=>t.$emit("clear-content"))},[d(i,{icon:"lucide:trash-2",class:"text-base"}),e[11]||(e[11]=b(" 清空聊天记录 ",-1))]),n("button",{class:"w-full text-left px-3 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--danger)"},onClick:e[3]||(e[3]=r=>t.$emit("close-room-menu"))},[d(i,{icon:"lucide:x-circle",class:"text-base"}),e[12]||(e[12]=b(" 关闭频道 ",-1))])])):f("",!0)])):f("",!0),s.inRoom?(l(),c("button",de,[d(i,{icon:"lucide:search",class:"text-base"})])):f("",!0),n("button",{class:_(["flex items-center gap-1 px-2 py-1.5 rounded-lg text-sm font-medium transition-colors",{"hover:bg-[var(--surface-2)]":!s.showChannelDrawer}]),style:w(s.showChannelDrawer?"background: var(--surface-3); color: var(--ink-0)":"color: var(--ink-2)"),"aria-label":"切换频道列表",onClick:e[4]||(e[4]=r=>t.$emit("toggle-drawer"))},[d(i,{icon:"lucide:hash",class:"text-base"}),d(i,{icon:s.showChannelDrawer?"lucide:panel-right-close":"lucide:panel-right-open",class:"text-base hidden md:block"},null,8,["icon"])],6)])]),s.inRoom?(l(),c("div",me,[n("div",he,[e[14]||(e[14]=n("span",{class:"w-2 h-2 rounded-full shrink-0 status-dot-green",style:{background:"var(--state-green)"}},null,-1)),n("span",ue,u(s.channelTitle),1),n("span",fe,u(s.memberCount)+" 人在线",1)]),n("div",ve,[s.isOwner?(l(),c("button",{key:0,class:"px-2 py-1 rounded-lg text-xs font-medium transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--danger)"},onClick:e[5]||(e[5]=r=>t.$emit("close-room-header"))}," 关闭频道 ")):(l(),c("button",{key:1,class:"px-2 py-1 rounded-lg text-xs font-medium transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--ink-2)"},onClick:e[6]||(e[6]=r=>t.$emit("leave-room"))}," 离开 "))])])):f("",!0)])}const ye=y(ee,[["render",we]]),ge=p({__name:"ChatMessageList",props:{messages:{},myUserId:{},ownerUserId:{},formatTime:{type:Function},formatFileSize:{type:Function},getInitial:{type:Function},getAvatarColor:{type:Function},fileDownloadUrl:{type:Function},showDateSeparator:{type:Function},dateSeparatorText:{type:Function},systemMessageText:{type:Function}},emits:["copy","scroll"],setup(t,{expose:e,emit:s}){e();const o=s;function a(i){const r=i.target;o("scroll",r?.scrollTop||0)}const m={emit:o,handleScroll:a};return Object.defineProperty(m,"__isScriptSetup",{enumerable:!1,value:!0}),m}}),pe={key:0,class:"flex flex-col items-center justify-center h-full animate-fade-in-up"},be={key:0,class:"flex items-center justify-center my-6"},xe={class:"px-3 py-1 rounded-full text-xs",style:{background:"var(--surface-2)",color:"var(--ink-3)"}},ke={key:1,class:"flex gap-3 mb-4 message-bubble-wrap group"},Ce={class:"text-xs font-semibold",style:{color:"var(--ink-1)"}},_e={class:"flex-1 min-w-0"},Se={class:"flex items-center gap-2 mb-1"},Te={class:"text-sm font-semibold truncate",style:{color:"var(--ink-0)"}},Me={key:0,class:"text-xs px-1.5 py-0.5 rounded font-medium",style:{background:"var(--state-green)",color:"white"}},Ie={class:"text-xs shrink-0",style:{color:"var(--ink-3)"}},Re={class:"relative"},Ee=["onClick"],De={key:2,class:"flex gap-3 mb-4"},je={class:"text-xs font-semibold",style:{color:"var(--ink-1)"}},Oe={class:"flex-1 min-w-0"},Fe={class:"flex items-center gap-2 mb-1"},Ue={class:"text-sm font-semibold truncate",style:{color:"var(--ink-0)"}},Je={class:"text-xs shrink-0",style:{color:"var(--ink-3)"}},Be={class:"flex items-center justify-between p-3 rounded-lg border max-w-xs",style:{background:"var(--surface-2)","border-color":"color-mix(in srgb, var(--ink-4) 40%, transparent)"}},Ae={class:"flex items-center gap-2 min-w-0"},Ne={class:"min-w-0"},ze={class:"text-sm font-medium truncate block",style:{color:"var(--ink-1)"}},Le={class:"text-xs",style:{color:"var(--ink-3)"}},$e=["href"],Ke={key:3,class:"flex justify-center my-3"},He={class:"text-xs px-3 py-1 rounded-full",style:{background:"var(--surface-2)",color:"var(--ink-3)"}};function Pe(t,e,s,o,a,m){const i=g("iconify-icon");return l(),c("div",{id:"messagesContainer",class:"flex-1 overflow-y-auto px-4 md:px-6 py-4",onScroll:o.handleScroll},[s.messages.length===0?(l(),c("div",pe,[d(i,{icon:"lucide:message-square",class:"text-3xl mb-3",style:{color:"var(--ink-4)"}}),e[0]||(e[0]=n("p",{class:"text-sm",style:{color:"var(--ink-3)"}},"还没有消息，发送第一条吧",-1))])):(l(!0),c(x,{key:1},T(s.messages,(r,v)=>(l(),c("div",{key:`${r.clientMessageId||""}-${r.ts||""}-${v}`},[s.showDateSeparator(r,v)?(l(),c("div",be,[n("div",xe,u(s.dateSeparatorText(r)),1)])):f("",!0),r.type==="text"?(l(),c("div",ke,[n("div",{class:"w-8 h-8 rounded-full shrink-0 flex items-center justify-center",style:w(`background:${s.getAvatarColor(r.username||"")}`)},[n("span",Ce,u(s.getInitial(r.username||"")),1)],4),n("div",_e,[n("div",Se,[n("span",Te,u(r.userId===s.myUserId?"我":r.username),1),r.userId===s.ownerUserId?(l(),c("span",Me,"Owner")):f("",!0),n("span",Ie,u(s.formatTime(r.ts)),1)]),n("div",Re,[n("p",{class:"text-sm leading-relaxed rounded-lg px-3 py-2 w-fit max-w-[28rem] break-words whitespace-pre-wrap",style:w(r.userId===s.myUserId?"background: var(--ink-0); color: white;":"background: var(--surface-2); color: var(--ink-1);")},u(r.content),5),n("button",{class:"copy-btn absolute -right-1 top-1/2 -translate-y-1/2 opacity-0 transition-opacity flex items-center gap-1 px-2 py-1 rounded text-xs font-medium",style:{color:"var(--ink-2)",background:"var(--surface-1)","box-shadow":"var(--shadow-card)"},"aria-label":"复制消息",onClick:k=>t.$emit("copy",r.content||"")},[d(i,{icon:"lucide:copy",class:"text-sm"}),e[1]||(e[1]=n("span",{class:"hidden md:inline"},"复制",-1))],8,Ee)])])])):f("",!0),r.type==="file_ready"?(l(),c("div",De,[n("div",{class:"w-8 h-8 rounded-full shrink-0 flex items-center justify-center",style:w(`background:${s.getAvatarColor(r.username||"")}`)},[n("span",je,u(s.getInitial(r.username||"")),1)],4),n("div",Oe,[n("div",Fe,[n("span",Ue,u(r.userId===s.myUserId?"我":r.username),1),n("span",Je,u(s.formatTime(r.ts)),1)]),n("div",Be,[n("div",Ae,[d(i,{icon:"lucide:file",class:"shrink-0",style:{color:"var(--ink-1)"}}),n("div",Ne,[n("span",ze,u(r.name||"附件"),1),n("span",Le,u(s.formatFileSize(r.size||0)),1)])]),n("a",{href:s.fileDownloadUrl(r.fileId||""),target:"_blank",class:"shrink-0 ml-2",style:{color:"var(--ink-2)"},"aria-label":"下载附件"},[d(i,{icon:"lucide:download",class:"text-lg"})],8,$e)])])])):f("",!0),r.type==="member_joined"||r.type==="member_left"||r.type==="member_kicked"||r.type==="content_cleared"?(l(),c("div",Ke,[n("span",He,u(s.systemMessageText(r)),1)])):f("",!0)]))),128))],32)}const Ve=y(ge,[["render",Pe]]),We=p({inheritAttrs:!1,__name:"ChatComposer",props:{inRoom:{type:Boolean},draft:{},pendingFiles:{},sending:{type:Boolean}},emits:["update:draft","send","file-select","remove-file","resize"],setup(t,{expose:e,emit:s}){e();const o=t,a=s,m=I(()=>o.sending||!o.draft.trim()&&o.pendingFiles.length===0),i=I(()=>m.value?"background: var(--surface-2); color: var(--ink-3)":"background: var(--ink-0); color: white");function r(k){const M=k.target;M&&(a("update:draft",M.value),a("resize",k))}const v={props:o,emit:a,disabled:m,sendButtonStyle:i,onInput:r};return Object.defineProperty(v,"__isScriptSetup",{enumerable:!1,value:!0}),v}}),Xe={key:0,class:"shrink-0 border-t px-4 md:px-6 py-3",style:{"border-color":"color-mix(in srgb, var(--ink-4) 60%, transparent)",background:"var(--surface-1)"}},Ye={key:0,class:"mb-3 flex flex-wrap gap-2"},qe={class:"max-w-[180px] truncate"},Ge=["onClick"],Qe={class:"flex items-end gap-2"},Ze={class:"shrink-0 inline-flex items-center justify-center w-9 h-9 rounded-lg border cursor-pointer hover:bg-[var(--surface-2)] transition-colors",style:{"border-color":"var(--ink-4)",color:"var(--ink-2)"}},et={class:"flex-1"},tt=["value"],ot=["disabled"];function st(t,e,s,o,a,m){const i=g("iconify-icon");return s.inRoom?(l(),c("div",Xe,[s.pendingFiles.length>0?(l(),c("div",Ye,[(l(!0),c(x,null,T(s.pendingFiles,(r,v)=>(l(),c("div",{key:`${r.name}-${v}`,class:"inline-flex items-center gap-2 rounded-lg border px-2.5 py-1.5 text-xs",style:{background:"var(--surface-2)","border-color":"var(--ink-4)",color:"var(--ink-1)"}},[d(i,{icon:"lucide:paperclip",class:"text-sm"}),n("span",qe,u(r.name),1),n("button",{class:"inline-flex items-center","aria-label":"移除附件",onClick:k=>t.$emit("remove-file",v)},[d(i,{icon:"lucide:x",class:"text-sm"})],8,Ge)]))),128))])):f("",!0),n("div",Qe,[n("label",Ze,[n("input",{class:"hidden",type:"file",multiple:"",onChange:e[0]||(e[0]=r=>t.$emit("file-select",r))},null,32),d(i,{icon:"lucide:paperclip",class:"text-base"})]),n("div",et,[n("textarea",{value:s.draft,rows:"1",class:"chat-input fh-input w-full resize-none px-3 py-2.5 rounded-xl border text-sm outline-none transition-all",style:{background:"var(--surface-0)","border-color":"var(--ink-4)",color:"var(--ink-0)","max-height":"120px"},placeholder:"输入消息...",onInput:o.onInput,onKeydown:e[1]||(e[1]=S(O(r=>t.$emit("send"),["exact","prevent"]),["enter"]))},null,40,tt)]),n("button",{class:"shrink-0 w-10 h-10 rounded-xl text-sm font-semibold transition-all flex items-center justify-center",style:w(o.sendButtonStyle),disabled:o.disabled,onClick:e[2]||(e[2]=r=>t.$emit("send"))},[d(i,{icon:"lucide:send",class:"text-base",style:w(s.sending?"animation: spin 0.8s linear infinite":"")},null,8,["style"])],12,ot)])])):f("",!0)}const nt=y(We,[["render",st]]),rt=p({__name:"ChatDrawer",props:{show:{type:Boolean},inRoom:{type:Boolean},isOwner:{type:Boolean},roomCode:{},joinCode:{}},emits:["close","connect-my-room","join-code","update:join-code","leave-room","close-room"],setup(t,{expose:e}){e();const s={};return Object.defineProperty(s,"__isScriptSetup",{enumerable:!1,value:!0}),s}}),it={class:"h-14 md:h-auto md:pt-0 px-4 border-b flex items-center justify-between",style:{"border-color":"var(--ink-4)","padding-top":"env(safe-area-inset-top)"}},at={class:"p-3 border-b",style:{"border-color":"var(--ink-4)"}},lt={class:"flex items-center gap-2"},ct={key:0,class:"mt-2 px-3 py-2 rounded-lg",style:{background:"var(--surface-2)"}},dt={class:"text-sm font-medium",style:{color:"var(--ink-0)"}},mt={class:"p-3 border-b",style:{"border-color":"var(--ink-4)"}},ht={class:"flex gap-2"},ut=["value"],ft={class:"p-3"};function vt(t,e,s,o,a,m){const i=g("iconify-icon");return l(),c(x,null,[n("div",{class:_(["drawer-overlay fixed inset-0 z-40 bg-black/20 md:hidden",s.show?"visible-overlay":"hidden-overlay"]),onClick:e[0]||(e[0]=r=>t.$emit("close"))},null,2),n("aside",{class:_(["drawer-panel w-[300px] max-w-[82vw] border-l shrink-0 bg-surface-1 h-full fixed md:static right-0 top-0 md:top-auto z-50",s.show?"open":"closed"]),style:{"border-color":"var(--ink-4)"}},[n("div",it,[e[8]||(e[8]=n("h3",{class:"text-xl font-semibold",style:{color:"var(--ink-0)","font-family":"var(--font-heading)"}},"频道",-1)),n("button",{class:"md:hidden p-1",style:{color:"var(--ink-2)"},onClick:e[1]||(e[1]=r=>t.$emit("close"))},[d(i,{icon:"lucide:x",class:"text-lg"})])]),n("div",at,[e[12]||(e[12]=n("div",{class:"text-xs mb-2",style:{color:"var(--ink-3)"}},"我的频道",-1)),n("button",{class:"channel-item active w-full text-left px-3 py-2 rounded-lg border-l-2",style:{"border-left-color":"var(--ink-0)"},onClick:e[2]||(e[2]=r=>t.$emit("connect-my-room"))},[n("div",lt,[d(i,{icon:"lucide:hash",class:"text-sm",style:{color:"var(--ink-2)"}}),e[9]||(e[9]=n("span",{class:"text-sm font-medium",style:{color:"var(--ink-0)"}},"我的频道",-1))]),e[10]||(e[10]=n("div",{class:"text-xs mt-1",style:{color:"var(--ink-3)"}},"点击进入你的频道",-1))]),s.inRoom&&!s.isOwner?(l(),c("div",ct,[e[11]||(e[11]=n("div",{class:"text-xs",style:{color:"var(--ink-3)"}},"当前加入",-1)),n("div",dt,"# "+u(s.roomCode),1)])):f("",!0)]),n("div",mt,[e[13]||(e[13]=n("div",{class:"text-xs mb-2",style:{color:"var(--ink-3)"}},"加入频道",-1)),n("div",ht,[n("input",{value:s.joinCode,type:"text",inputmode:"numeric",maxlength:"18",class:"fh-input flex-1 px-3 py-2 rounded-lg border text-sm outline-none",placeholder:"输入号码",style:{background:"var(--surface-0)","border-color":"var(--ink-4)",color:"var(--ink-0)"},onInput:e[3]||(e[3]=r=>t.$emit("update:join-code",r.target.value)),onKeydown:e[4]||(e[4]=S(r=>t.$emit("join-code"),["enter"]))},null,40,ut),n("button",{class:"px-3 py-2 rounded-lg text-sm font-semibold border",style:{"border-color":"var(--ink-4)",color:"var(--ink-1)"},onClick:e[5]||(e[5]=r=>t.$emit("join-code"))}," 加入 ")])]),n("div",ft,[s.inRoom&&!s.isOwner?(l(),c("button",{key:0,class:"w-full px-3 py-2 rounded-lg text-sm font-medium border",style:{"border-color":"var(--ink-4)",color:"var(--ink-2)"},onClick:e[6]||(e[6]=r=>t.$emit("leave-room"))}," 退出当前频道 ")):f("",!0),s.inRoom&&s.isOwner?(l(),c("button",{key:1,class:"w-full px-3 py-2 rounded-lg text-sm font-medium border",style:{"border-color":"var(--danger)",color:"var(--danger)"},onClick:e[7]||(e[7]=r=>t.$emit("close-room"))}," 关闭我的频道 ")):f("",!0)])],2)],64)}const wt=y(rt,[["render",vt]]),yt=p({__name:"ChatMembersPanel",props:{show:{type:Boolean},members:{},myUserId:{},isOwner:{type:Boolean}},emits:["close","kick"],setup(t,{expose:e}){e();const s={};return Object.defineProperty(s,"__isScriptSetup",{enumerable:!1,value:!0}),s}}),gt={key:0,class:"fixed inset-0 z-[70] flex items-center justify-center p-4",role:"dialog","aria-label":"成员管理"},pt={class:"relative w-full max-w-md rounded-2xl border p-4 md:p-5 modal-content",style:{background:"var(--surface-1)","border-color":"var(--ink-4)","box-shadow":"var(--shadow-modal)"}},bt={class:"flex items-center justify-between mb-3"},xt={class:"max-h-[55vh] overflow-y-auto"},kt={class:"min-w-0"},Ct={class:"text-sm font-medium truncate",style:{color:"var(--ink-0)"}},_t={key:0,class:"text-xs ml-1",style:{color:"var(--ink-3)"}},St={class:"text-xs",style:{color:"var(--ink-3)"}},Tt=["onClick"];function Mt(t,e,s,o,a,m){const i=g("iconify-icon");return s.show?(l(),c("div",gt,[n("div",{class:"absolute inset-0 bg-black/30",onClick:e[0]||(e[0]=r=>t.$emit("close"))}),n("div",pt,[n("div",bt,[e[2]||(e[2]=n("h3",{class:"text-lg font-semibold",style:{color:"var(--ink-0)","font-family":"var(--font-heading)"}},"频道成员",-1)),n("button",{class:"p-1",style:{color:"var(--ink-2)"},onClick:e[1]||(e[1]=r=>t.$emit("close"))},[d(i,{icon:"lucide:x",class:"text-base"})])]),n("div",xt,[(l(!0),c(x,null,T(s.members,r=>(l(),c("div",{key:r.memberId,class:"member-row flex items-center justify-between rounded-lg px-2.5 py-2"},[n("div",kt,[n("div",Ct,[b(u(r.userId===s.myUserId?"我":r.username)+" ",1),r.isOwner?(l(),c("span",_t,"(Owner)")):f("",!0)]),n("div",St,"# "+u(r.userNumber||"---"),1)]),s.isOwner&&!r.isOwner?(l(),c("button",{key:0,class:"px-2.5 py-1.5 rounded-lg text-xs font-medium",style:{color:"var(--danger)",background:"var(--danger-subtle)"},onClick:v=>t.$emit("kick",r)}," 移除 ",8,Tt)):f("",!0)]))),128))])])])):f("",!0)}const It=y(yt,[["render",Mt]]),h={AUTH:"auth",AUTHED:"authed",CREATE:"my_room",JOIN:"join",LEAVE:"leave",LEFT:"left",TEXT:"text",FILE_READY:"file_ready",CLEAR_CONTENT:"clear_content",CONTENT_CLEARED:"content_cleared",KICK_MEMBER:"kick_member",MEMBER_JOINED:"member_joined",MEMBER_LEFT:"member_left",MEMBER_KICKED:"member_kicked",ROOM_STATE:"room_state",CREATED:"created",JOINED:"joined",ERROR:"error",ROOM_CLOSED:"room_closed"};class Rt{client;constructor(){this.client=new L("/chat")}on(e,s){this.client.on(e,s)}connect(){this.client.connect()}send(e){this.client.send(e)}close(){this.client.close()}get connected(){return this.client.connected}async uploadFile(e,s,o){return U(e,s,o)}fileDownloadUrl(e,s,o){return J(e,s,o)}}function D(t){return{memberId:String(t?.memberId||t?.member_id||""),userId:String(t?.userId||t?.user_id||""),username:String(t?.username||"用户"),userNumber:t?.userNumber?String(t.userNumber):t?.user_number?String(t.user_number):"",isOwner:!!(t?.isOwner||t?.is_owner),joinedAt:Number(t?.joinedAt||t?.joined_at||0)||void 0}}function Et(t){if(!Array.isArray(t))return[];const e=new Set(["text","file_ready","message","msg","chat_message","file"]);return t.filter(s=>s&&typeof s=="object").filter(s=>{const o=String(s.type||"").trim();return!o||e.has(o)})}function j(t){if(!t||typeof t!="object")return null;const e={...t};return!e.type||e.type==="message"||e.type==="msg"||e.type==="chat_message"?e.type="text":e.type==="file"&&(e.type="file_ready"),e.content==null&&typeof e.text=="string"&&(e.content=e.text),e.content==null&&typeof e.message=="string"&&(e.content=e.message),e.content==null&&(e.content=""),e.ts==null&&(e.ts=Date.now()),e.username=String(e.username||""),e.userId!=null&&(e.userId=String(e.userId)),e.clientMessageId!=null&&(e.clientMessageId=String(e.clientMessageId)),e.fileId!=null&&(e.fileId=String(e.fileId)),e.name!=null&&(e.name=String(e.name)),e.size!=null&&(e.size=Number(e.size)),e}function Dt(t){return t==="error"?"error":"info"}const jt=B("chat",{state:()=>({loading:!0,myUserId:"",myUsername:"",myUserNumber:"",authToken:"",service:null,connected:!1,connecting:!1,currentRoom:null,roomId:"",roomCode:"",isOwner:!1,ownerUserId:"",members:[],memberCount:0,messages:[],pendingClientMessageIds:[],channelTitle:"",pendingJoinTarget:null,skipNextRoomClosedToast:!1,joinCode:"",drawerJoinCode:"",draft:"",pendingFiles:[],sending:!1,entryError:"",showChannelDrawer:typeof window<"u"?window.innerWidth>=768:!0,showOwnerMenu:!1,showMembersModal:!1,showClearConfirm:!1,showKickConfirm:!1,kickTarget:null,clearCountdown:0,clearTimer:null,showSwitchJoinConfirm:!1,switchJoinDecision:null,toast:null,toastExiting:!1,toastTimer:null,pageshowHandler:null}),getters:{inRoom:t=>!!(t.currentRoom&&t.roomId),viewMode(){return this.loading?"loading":this.inRoom?"room":"entry"},safeMessages:t=>Array.isArray(t.messages)?t.messages:[],displayMessages(){const t=new Set(["text","file_ready","member_joined","member_left","member_kicked","content_cleared"]);return this.safeMessages.map(e=>j(e)).filter(e=>!!(e&&t.has(String(e.type||""))))},switchJoinPrompt(t){return t.switchJoinDecision?.prompt||""}},actions:{normalizeMessage(t){return j(t)},appendMessage(t){const e=this.normalizeMessage(t);e&&(this.messages=[...this.safeMessages,e])},replaceMessageAt(t,e){const s=this.normalizeMessage(e);s&&(t<0||t>=this.safeMessages.length||(this.messages=[...this.safeMessages.slice(0,t),s,...this.safeMessages.slice(t+1)]))},consumeLocalEcho(t){const e=this.normalizeMessage(t);if(!e||e.type!=="text"||String(e.userId||"")!==this.myUserId)return!1;const s=String(e.clientMessageId||""),o=this.safeMessages.findIndex(a=>a&&a.type==="text"&&a.isLocalEcho===!0&&(s&&String(a.clientMessageId||"")===s||a.content===e.content));return o<0?!1:(this.replaceMessageAt(o,e),s&&(this.pendingClientMessageIds=this.pendingClientMessageIds.filter(a=>a!==s)),!0)},defer(t){Promise.resolve().then(t)},resetTransientUi(){this.showOwnerMenu=!1,this.showMembersModal=!1,this.showClearConfirm=!1,this.showKickConfirm=!1,this.kickTarget=null,this.showSwitchJoinConfirm=!1,this.switchJoinDecision=null,this.clearCountdown=0,this.clearTimer&&(window.clearInterval(this.clearTimer),this.clearTimer=null)},resetRoomState(){this.currentRoom=null,this.roomId="",this.roomCode="",this.isOwner=!1,this.ownerUserId="",this.memberCount=0,this.channelTitle="",this.messages=[],this.pendingClientMessageIds=[],this.members=[],this.draft="",this.pendingFiles=[],this.connecting=!1,this.resetTransientUi(),E("")},showToast(t,e="info"){this.toastTimer&&window.clearTimeout(this.toastTimer),this.toastExiting=!1,this.toast={message:t,type:e},this.toastTimer=window.setTimeout(()=>{this.toastExiting=!0,window.setTimeout(()=>{this.toast=null},200)},2500)},async init(){this.resetTransientUi(),this.loading=!0,this.pageshowHandler&&window.removeEventListener("pageshow",this.pageshowHandler),this.pageshowHandler=()=>{this.resetTransientUi()},window.addEventListener("pageshow",this.pageshowHandler);const t=C();if(!await t.restoreSession()||!t.user||!t.token){window.location.href="/applications/auth";return}this.myUserId=String(t.user.id||""),this.myUsername=String(t.user.username||""),this.myUserNumber=t.user.userNumber?String(t.user.userNumber):"",this.authToken=String(t.token||""),this.loading=!1,this.setupWebSocket();const s=G();s==="my_room"?window.setTimeout(()=>this.connectMyRoom(),100):/^\d{4,18}$/.test(String(s||""))&&(this.joinCode=String(s||""),window.setTimeout(()=>this.joinRoom(),120))},setupWebSocket(){if(this.service)return;const t=C();this.service=new Rt,this.service.on("_open",()=>{this.service?.send({type:h.AUTH,token:this.authToken})}),this.service.on(h.AUTHED,()=>{this.connected=!0});const e=s=>this.handleRoomEntered(s);this.service.on(h.CREATED,e),this.service.on(h.JOINED,e),this.service.on(h.ROOM_STATE,e),this.service.on(h.TEXT,s=>{if(this.consumeLocalEcho(s)){this.defer(()=>this.scrollToBottom());return}this.appendMessage(s),this.defer(()=>this.scrollToBottom())}),this.service.on(h.FILE_READY,s=>{this.appendMessage(s),this.defer(()=>this.scrollToBottom())}),this.service.on(h.MEMBER_JOINED,s=>{this.memberCount=Number(s?.count||this.memberCount);const o=D(s?.member||{});if(!o.memberId)return;this.members.some(m=>m.memberId===o.memberId)||(this.members=[...this.members,o]),this.appendMessage({type:"member_joined",username:o.username,ts:Date.now()}),this.defer(()=>this.scrollToBottom())}),this.service.on(h.MEMBER_LEFT,s=>{this.memberCount=Number(s?.count||this.memberCount);const o=String(s?.memberId||s?.member_id||""),a=this.members.find(m=>m.memberId===o);this.members=this.members.filter(m=>m.memberId!==o),this.appendMessage({type:"member_left",username:a?.username||"用户",ts:Date.now()}),this.defer(()=>this.scrollToBottom())}),this.service.on(h.MEMBER_KICKED,s=>{this.memberCount=Number(s?.count||this.memberCount);const o=String(s?.memberId||s?.member_id||""),a=this.members.find(m=>m.memberId===o);this.members=this.members.filter(m=>m.memberId!==o),String(s?.userId||s?.user_id||"")===this.myUserId?this.handleRoomExited({toast:"你已被移出频道",toastType:"error"}):(this.appendMessage({type:"member_kicked",username:a?.username||"用户",ts:Date.now()}),this.defer(()=>this.scrollToBottom()))}),this.service.on(h.CONTENT_CLEARED,()=>{this.messages=[],this.showToast("聊天记录已清空"),this.showClearConfirm=!1}),this.service.on(h.ROOM_CLOSED,()=>{const s=this.skipNextRoomClosedToast?"":"频道已关闭",o=this.skipNextRoomClosedToast?"info":"error";this.skipNextRoomClosedToast=!1,this.handleRoomExited({toast:s,toastType:o})}),this.service.on(h.LEFT,()=>{this.handleRoomExited()}),this.service.on(h.ERROR,async s=>{if(s?.code==="auth_failed"){const o=await t.refreshSession();if(o&&o.token){this.authToken=String(o.token),this.service?.send({type:h.AUTH,token:this.authToken});return}await t.logout(),window.location.href="/applications/auth";return}this.showToast(s?.message||"操作失败","error"),this.connecting=!1}),this.service.on("_close",()=>{this.connected=!1,this.inRoom&&this.showToast("连接中断，正在重连…","error")}),this.service.connect()},handleRoomEntered(t){const e=String(t?.roomId||t?.room_id||"").trim();if(!e){this.handleRoomExited({toast:"频道状态异常，请重新加入",toastType:"error"});return}this.currentRoom=t,this.roomId=e,this.roomCode=String(t?.code||""),this.isOwner=!!(t?.isOwner||t?.is_owner),this.ownerUserId=String(t?.ownerUserId||t?.owner_user_id||""),this.members=Array.isArray(t?.members)?t.members.map(i=>D(i)):[],this.memberCount=Number(t?.memberCount||t?.member_count||this.members.length||0);const s=Et(t?.history||t?.messages).map(i=>this.normalizeMessage(i)).filter(i=>!!i),o=this.safeMessages.filter(i=>i&&i.type==="text"&&i.isLocalEcho===!0&&String(i.userId||"")===this.myUserId),a=[...s];for(const i of o)a.some(v=>v&&v.type==="text"&&String(v.userId||"")===this.myUserId&&v.content===i.content)||a.push(i);this.messages=a,this.pendingClientMessageIds=this.pendingClientMessageIds.filter(i=>a.some(r=>String(r?.clientMessageId||"")===String(i||""))),this.channelTitle=this.isOwner?"我的频道":this.roomCode||"频道",this.connecting=!1,this.entryError="",this.resetTransientUi(),this.skipNextRoomClosedToast=!1;const m=q(this.roomCode);this.draft=m||"",E(this.isOwner?"my_room":this.roomCode),this.defer(()=>{this.scrollToBottom(),this.restoreMessageScroll()})},handleRoomExited(t={}){this.resetRoomState(),t.toast&&this.showToast(t.toast,Dt(String(t.toastType||"info"))),this.defer(()=>this.consumePendingJoin())},consumePendingJoin(){const t=this.pendingJoinTarget;if(t){if(this.pendingJoinTarget=null,t.type==="my_room"){this.connectMyRoom();return}t.type==="join_code"&&t.code&&(this.joinCode=t.code,this.joinRoom({bypassCurrentRoomCheck:!0}))}},isWsReady(){return!!this.service?.connected},connectMyRoom(){if(this.inRoom&&this.isOwner){this.showToast("你已经在自己的频道");return}if(this.inRoom&&!this.isOwner){this.switchJoinDecision={action:"leave_then_join",target:"my_room",prompt:"你当前在其他频道中。要先退出当前频道，再进入你的频道吗？"},this.showSwitchJoinConfirm=!0;return}if(!this.connected){this.service?.connect(),window.setTimeout(()=>this.connectMyRoom(),500);return}this.pendingJoinTarget=null,this.connecting=!0,this.entryError="",this.service?.send({type:h.CREATE})},joinRoom(t={}){const e=!!t.bypassCurrentRoomCheck,s=String(this.joinCode||"").trim();if(s){if(!/^\d{4,18}$/.test(s)){this.entryError="请输入 4-18 位数字号码";return}if(!e){const o=Y({currentRoom:this.currentRoom,isOwner:this.isOwner,currentCode:this.roomCode,targetCode:s,roomLabel:"频道"});if(o.action==="already_in_target"){this.entryError="",this.showToast("你已经在这个频道");return}if(o.action==="close_then_join"||o.action==="leave_then_join"){this.switchJoinDecision={action:o.action,target:"join_code",code:s,prompt:o.prompt},this.showSwitchJoinConfirm=!0;return}}if(!this.connected){this.service?.connect(),window.setTimeout(()=>this.joinRoom({bypassCurrentRoomCheck:!0}),500);return}this.pendingJoinTarget=null,this.connecting=!0,this.entryError="",this.service?.send({type:h.JOIN,code:s})}},joinRoomFromDrawer(){this.joinCode=String(this.drawerJoinCode||"").trim(),this.drawerJoinCode="",this.showChannelDrawer=!1,this.joinRoom()},confirmSwitchJoin(){const t=this.switchJoinDecision;if(!t){this.showSwitchJoinConfirm=!1;return}this.showSwitchJoinConfirm=!1,this.switchJoinDecision=null,t.target==="my_room"?this.pendingJoinTarget={type:"my_room"}:this.pendingJoinTarget={type:"join_code",code:String(t.code||"")},t.action==="close_then_join"?this.closeRoom("switch_join"):this.leaveRoom()},cancelSwitchJoin(){this.showSwitchJoinConfirm=!1,this.switchJoinDecision=null,this.pendingJoinTarget=null},leaveRoom(){this.inRoom&&(this.draft&&this.roomCode&&R(this.roomCode,this.draft),this.showOwnerMenu=!1,this.service?.send({type:h.LEAVE}))},closeRoom(t="owner_close"){!this.inRoom||!this.isOwner||(this.showOwnerMenu=!1,t==="switch_join"&&(this.skipNextRoomClosedToast=!0),this.service?.send({type:"close_room",reason:t}))},async sendMessage(){if(this.sending)return;if(!this.inRoom){this.showToast("请先进入频道","error");return}if(!this.isWsReady()){this.service?.connect(),this.showToast("连接中，请稍后重试","error");return}const t=this.draft.trim(),e=[...this.pendingFiles];if(!(!t&&e.length===0)){this.sending=!0;try{for(const s of e)if(!await this.uploadAndSendFile(s))break;if(this.pendingFiles=[],t){const s=`${Date.now()}-${Math.random().toString(36).slice(2,8)}`;this.pendingClientMessageIds=[...this.pendingClientMessageIds,s].slice(-60),this.appendMessage({type:"text",userId:this.myUserId,username:this.myUsername||"我",content:t,ts:Date.now(),isLocalEcho:!0,clientMessageId:s}),this.service?.send({type:h.TEXT,content:t,clientMessageId:s}),this.draft="",this.roomCode&&X(this.roomCode),this.defer(()=>this.scrollToBottom())}}finally{this.sending=!1}}},async uploadAndSendFile(t){if(!this.inRoom||!this.service)return!1;const e=C(),s=o=>{this.service?.send({type:h.FILE_READY,fileId:o.fileId,name:t.name,size:t.size,mime:t.type||"application/octet-stream"})};try{const o=await this.service.uploadFile(this.roomId,t,this.authToken);return!o||!o.fileId?(this.showToast("文件上传失败","error"),!1):(s(o),!0)}catch(o){if(Number(o?.status)===401){const a=await e.refreshSession();if(a&&a.token){this.authToken=String(a.token);try{const m=await this.service.uploadFile(this.roomId,t,this.authToken);return!m||!m.fileId?(this.showToast("文件上传失败","error"),!1):(s(m),!0)}catch{return this.showToast("文件上传失败","error"),!1}}return await e.logout(),window.location.href="/applications/auth",!1}return this.showToast("文件上传失败","error"),!1}},onFileSelect(t){const e=t.target,s=e?.files;if(!s||s.length===0)return;const o=[...this.pendingFiles];for(const a of s)o.push(a);this.pendingFiles=o,e&&(e.value="")},removePendingFile(t){this.pendingFiles=this.pendingFiles.filter((e,s)=>s!==t)},async copyMessage(t){try{await navigator.clipboard.writeText(t),this.showToast("已复制")}catch{this.showToast("复制失败","error")}},confirmClearChat(){this.showOwnerMenu=!1,this.showClearConfirm=!0,this.clearCountdown=3,this.clearTimer&&window.clearInterval(this.clearTimer),this.clearTimer=window.setInterval(()=>{this.clearCountdown-=1,this.clearCountdown<=0&&this.clearTimer&&(window.clearInterval(this.clearTimer),this.clearTimer=null)},1e3)},dismissClearConfirm(){this.showClearConfirm=!1,this.clearCountdown=0,this.clearTimer&&(window.clearInterval(this.clearTimer),this.clearTimer=null)},executeClearChat(){this.clearCountdown>0||(this.service?.send({type:h.CLEAR_CONTENT}),this.dismissClearConfirm())},confirmKickMember(t){!this.inRoom||!this.isOwner||!t?.memberId||t.isOwner||(this.kickTarget=t,this.showKickConfirm=!0,this.showMembersModal=!1)},dismissKickConfirm(){this.showKickConfirm=!1,this.kickTarget=null},executeKick(){if(!this.inRoom||!this.isOwner||!this.kickTarget?.memberId){this.dismissKickConfirm();return}this.service?.send({type:h.KICK_MEMBER,memberId:this.kickTarget.memberId}),this.dismissKickConfirm()},fileDownloadUrl(t){return this.service?this.service.fileDownloadUrl(t,this.roomId,this.authToken):"#"},systemMessageText(t){return t.type==="member_joined"?`${t.username||"用户"} 加入了频道`:t.type==="member_left"?`${t.username||"用户"} 离开了频道`:t.type==="member_kicked"?`${t.username||"用户"} 已被移除`:t.type==="content_cleared"?"聊天记录已被清空":""},showDateSeparator(t,e){if(e===0)return!0;const s=this.displayMessages[e-1];if(!s?.ts||!t?.ts)return!1;const o=new Date(s.ts).toDateString(),a=new Date(t.ts).toDateString();return o!==a},dateSeparatorText(t){if(!t.ts)return"";const e=new Date(t.ts),s=new Date;if(e.toDateString()===s.toDateString())return"今天";const o=new Date(s);return o.setDate(o.getDate()-1),e.toDateString()===o.toDateString()?"昨天":`${e.getMonth()+1}月${e.getDate()}日`},saveDraft(){this.roomCode&&R(this.roomCode,this.draft)},saveMessageScroll(t){this.roomCode&&W(this.roomCode,t)},restoreMessageScroll(){const t=document.getElementById("messagesContainer");if(!t||!this.roomCode)return;const e=V(this.roomCode);e>0&&(t.scrollTop=e)},scrollToBottom(){const t=document.getElementById("messagesContainer");t&&(t.scrollTop=t.scrollHeight)},autoResizeTextArea(t){const e=t.target;e&&(e.style.height="auto",e.style.height=`${Math.min(e.scrollHeight,120)}px`,this.saveDraft())},formatTime:P,formatFileSize:H,getInitial:K,getAvatarColor:$,destroy(){this.pageshowHandler&&(window.removeEventListener("pageshow",this.pageshowHandler),this.pageshowHandler=null),this.service&&(this.service.close(),this.service=null),this.connected=!1,this.connecting=!1,this.loading=!1,this.clearTimer&&(window.clearInterval(this.clearTimer),this.clearTimer=null),this.toastTimer&&(window.clearTimeout(this.toastTimer),this.toastTimer=null)}}}),Ot=p({__name:"ChatPage",setup(t,{expose:e}){e();const s=jt();function o(i){s.draft=i,s.saveDraft()}function a(){s.showOwnerMenu=!1,s.showMembersModal=!0}N(async()=>{await s.init()}),z(()=>{s.destroy()});const m={chatStore:s,onDraftChange:o,openMembersPanel:a,ChatHeader:ye,ChatMessageList:Ve,ChatComposer:nt,ChatDrawer:wt,ChatMembersPanel:It,ConfirmModal:Q,ToastHost:Z};return Object.defineProperty(m,"__isScriptSetup",{enumerable:!1,value:!0}),m}}),Ft={class:"h-screen bg-surface-0 font-sans relative noise-overlay grid-pattern flex flex-col overflow-hidden"},Ut={class:"flex-1 flex overflow-hidden"},Jt={class:"flex-1 flex flex-col min-w-0"},Bt={key:0,class:"flex-1 flex items-center justify-center"},At={key:1,class:"flex-1 flex flex-col items-center justify-center px-6 animate-fade-in-up"},Nt={class:"w-16 h-16 rounded-2xl flex items-center justify-center mb-6",style:{background:"var(--surface-2)"}},zt={class:"flex flex-col sm:flex-row gap-3 w-full max-w-sm"},Lt=["disabled"],$t={class:"mt-4 w-full max-w-sm"},Kt={class:"flex gap-2"},Ht=["disabled"],Pt={key:0,class:"mt-3 text-xs",style:{color:"var(--danger)"}},Vt={key:0,class:"fixed inset-0 z-[80] flex items-center justify-center p-4",role:"dialog","aria-label":"确认清空聊天记录"},Wt={class:"relative w-full max-w-sm rounded-2xl border p-6 text-center modal-content",style:{background:"var(--surface-1)","border-color":"var(--ink-4)","box-shadow":"var(--shadow-modal)"}},Xt={class:"flex gap-3"},Yt=["disabled"];function qt(t,e,s,o,a,m){const i=g("iconify-icon");return l(),c("div",Ft,[d(o.ChatHeader,{"in-room":o.chatStore.inRoom,"is-owner":o.chatStore.isOwner,"show-owner-menu":o.chatStore.showOwnerMenu,"show-channel-drawer":o.chatStore.showChannelDrawer,"channel-title":o.chatStore.channelTitle,"member-count":o.chatStore.memberCount,onToggleOwnerMenu:e[0]||(e[0]=r=>o.chatStore.showOwnerMenu=!o.chatStore.showOwnerMenu),onToggleDrawer:e[1]||(e[1]=r=>o.chatStore.showChannelDrawer=!o.chatStore.showChannelDrawer),onOpenMembers:o.openMembersPanel,onClearContent:e[2]||(e[2]=r=>o.chatStore.confirmClearChat()),onCloseRoomMenu:e[3]||(e[3]=r=>o.chatStore.closeRoom("owner_close_from_menu")),onCloseRoomHeader:e[4]||(e[4]=r=>o.chatStore.closeRoom("owner_close_from_header")),onLeaveRoom:e[5]||(e[5]=r=>o.chatStore.leaveRoom())},null,8,["in-room","is-owner","show-owner-menu","show-channel-drawer","channel-title","member-count"]),n("div",Ut,[n("div",Jt,[o.chatStore.viewMode==="loading"?(l(),c("div",Bt,[...e[25]||(e[25]=[n("div",{class:"w-8 h-8 border-2 rounded-full",style:{"border-color":"var(--ink-4)","border-top-color":"var(--ink-0)",animation:"spin 0.8s linear infinite"}},null,-1)])])):o.chatStore.viewMode==="entry"?(l(),c("div",At,[n("div",Nt,[d(i,{icon:"lucide:message-circle",class:"text-2xl",style:{color:"var(--ink-3)"}})]),e[27]||(e[27]=n("h2",{class:"text-xl font-semibold mb-2",style:{color:"var(--ink-0)","font-family":"var(--font-heading)"}},"开始聊天",-1)),e[28]||(e[28]=n("p",{class:"text-sm mb-8 text-center max-w-xs",style:{color:"var(--ink-2)"}},"打开你的频道，或输入用户号码加入他人的频道",-1)),n("div",zt,[n("button",{class:"flex-1 flex items-center justify-center gap-2 px-5 py-3 rounded-xl text-sm font-semibold transition-all",style:{background:"var(--ink-0)",color:"white"},disabled:o.chatStore.connecting,onClick:e[6]||(e[6]=r=>o.chatStore.connectMyRoom())},[d(i,{icon:"lucide:radio",class:"text-base"}),e[26]||(e[26]=b(" 我的频道 ",-1))],8,Lt)]),n("div",$t,[n("div",Kt,[A(n("input",{"onUpdate:modelValue":e[7]||(e[7]=r=>o.chatStore.joinCode=r),type:"text",inputmode:"numeric",maxlength:"18",class:"fh-input flex-1 px-4 py-2.5 rounded-xl border text-sm outline-none transition-all",placeholder:"输入用户号码加入频道",style:{background:"var(--surface-1)","border-color":"var(--ink-4)",color:"var(--ink-0)"},onKeydown:e[8]||(e[8]=S(r=>o.chatStore.joinRoom(),["enter"]))},null,544),[[F,o.chatStore.joinCode]]),n("button",{class:"px-5 py-2.5 rounded-xl text-sm font-semibold transition-all border",style:{"border-color":"var(--ink-4)",color:"var(--ink-1)"},disabled:o.chatStore.connecting||!o.chatStore.joinCode,onClick:e[9]||(e[9]=r=>o.chatStore.joinRoom())}," 加入 ",8,Ht)])]),o.chatStore.entryError?(l(),c("p",Pt,u(o.chatStore.entryError),1)):f("",!0)])):(l(),c(x,{key:2},[d(o.ChatMessageList,{messages:o.chatStore.displayMessages,"my-user-id":o.chatStore.myUserId,"owner-user-id":o.chatStore.ownerUserId,"format-time":o.chatStore.formatTime,"format-file-size":o.chatStore.formatFileSize,"get-initial":o.chatStore.getInitial,"get-avatar-color":o.chatStore.getAvatarColor,"file-download-url":o.chatStore.fileDownloadUrl,"show-date-separator":o.chatStore.showDateSeparator,"date-separator-text":o.chatStore.dateSeparatorText,"system-message-text":o.chatStore.systemMessageText,onCopy:o.chatStore.copyMessage,onScroll:o.chatStore.saveMessageScroll},null,8,["messages","my-user-id","owner-user-id","format-time","format-file-size","get-initial","get-avatar-color","file-download-url","show-date-separator","date-separator-text","system-message-text","onCopy","onScroll"]),d(o.ChatComposer,{"in-room":o.chatStore.inRoom,draft:o.chatStore.draft,"pending-files":o.chatStore.pendingFiles,sending:o.chatStore.sending,"onUpdate:draft":o.onDraftChange,onSend:e[10]||(e[10]=r=>o.chatStore.sendMessage()),onFileSelect:o.chatStore.onFileSelect,onRemoveFile:o.chatStore.removePendingFile,onResize:o.chatStore.autoResizeTextArea},null,8,["in-room","draft","pending-files","sending","onFileSelect","onRemoveFile","onResize"])],64))]),d(o.ChatDrawer,{show:o.chatStore.showChannelDrawer,"in-room":o.chatStore.inRoom,"is-owner":o.chatStore.isOwner,"room-code":o.chatStore.roomCode,"join-code":o.chatStore.drawerJoinCode,onClose:e[11]||(e[11]=r=>o.chatStore.showChannelDrawer=!1),onConnectMyRoom:e[12]||(e[12]=r=>o.chatStore.connectMyRoom()),onJoinCode:e[13]||(e[13]=r=>o.chatStore.joinRoomFromDrawer()),"onUpdate:joinCode":e[14]||(e[14]=r=>o.chatStore.drawerJoinCode=r),onLeaveRoom:e[15]||(e[15]=r=>o.chatStore.leaveRoom()),onCloseRoom:e[16]||(e[16]=r=>o.chatStore.closeRoom("owner_close_from_drawer"))},null,8,["show","in-room","is-owner","room-code","join-code"])]),d(o.ChatMembersPanel,{show:o.chatStore.showMembersModal,members:o.chatStore.members,"my-user-id":o.chatStore.myUserId,"is-owner":o.chatStore.isOwner,onClose:e[17]||(e[17]=r=>o.chatStore.showMembersModal=!1),onKick:o.chatStore.confirmKickMember},null,8,["show","members","my-user-id","is-owner","onKick"]),d(o.ConfirmModal,{"model-value":o.chatStore.showSwitchJoinConfirm,title:"切换频道",description:o.chatStore.switchJoinPrompt,"cancel-text":"取消","confirm-text":"继续","onUpdate:modelValue":e[18]||(e[18]=r=>r?o.chatStore.showSwitchJoinConfirm=!0:o.chatStore.cancelSwitchJoin()),onConfirm:e[19]||(e[19]=r=>o.chatStore.confirmSwitchJoin())},null,8,["model-value","description"]),d(o.ConfirmModal,{"model-value":o.chatStore.showKickConfirm,title:"确认移除成员?",description:`确定要将 ${o.chatStore.kickTarget?.username||"该成员"} 从频道中移除吗？`,"cancel-text":"取消","confirm-text":"移除",danger:!0,"onUpdate:modelValue":e[20]||(e[20]=r=>r?o.chatStore.showKickConfirm=!0:o.chatStore.dismissKickConfirm()),onConfirm:e[21]||(e[21]=r=>o.chatStore.executeKick())},null,8,["model-value","description"]),o.chatStore.showClearConfirm?(l(),c("div",Vt,[n("div",{class:"absolute inset-0 bg-black/30",onClick:e[22]||(e[22]=r=>o.chatStore.dismissClearConfirm())}),n("div",Wt,[e[29]||(e[29]=n("h3",{class:"text-lg font-semibold mb-2",style:{color:"var(--ink-0)","font-family":"var(--font-heading)"}},"确认清空聊天记录?",-1)),e[30]||(e[30]=n("p",{class:"text-sm mb-6",style:{color:"var(--ink-2)"}},"此操作不可恢复，请确认后继续。",-1)),n("div",Xt,[n("button",{class:"flex-1 py-2.5 rounded-xl text-sm font-medium border",style:{"border-color":"var(--ink-4)",color:"var(--ink-1)"},onClick:e[23]||(e[23]=r=>o.chatStore.dismissClearConfirm())},"取消"),n("button",{class:"flex-1 py-2.5 rounded-xl text-sm font-semibold",style:w(o.chatStore.clearCountdown>0?"background: var(--ink-3); color: white;":"background: var(--danger); color: white;"),disabled:o.chatStore.clearCountdown>0,onClick:e[24]||(e[24]=r=>o.chatStore.executeClearChat())},u(o.chatStore.clearCountdown>0?`${o.chatStore.clearCountdown}s`:"清空"),13,Yt)])])])):f("",!0),d(o.ToastHost,{toast:o.chatStore.toast,exiting:o.chatStore.toastExiting},null,8,["toast","exiting"])])}const oo=y(Ot,[["render",qt]]);export{oo as default};
