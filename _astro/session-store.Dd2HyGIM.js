import{p as H,r as S,j as I}from"./pinia.GsotNk0y.js";const q=(t,e)=>{const r=t.__vccOpts||t;for(const[n,o]of e)r[n]=o;return r},E=typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"),$=typeof window<"u"&&window.location.protocol==="https:"?"wss:":"ws:",w=E?`${window.location.protocol}//localhost:8080`:"https://api.wuhao.tech",B=E?`${$}//localhost:8080`:"wss://api.wuhao.tech";function p(t){if(!t||typeof t!="object")return{id:"",username:""};const e={...t};return!e.userNumber&&e.user_number&&(e.userNumber=e.user_number),!e.publicUserId&&e.public_user_id&&(e.publicUserId=e.public_user_id),e}function A(t){if(!t||typeof t!="object")return t;const e={...t};return!e.accessToken&&e.access_token&&(e.accessToken=e.access_token),!e.access_token&&e.accessToken&&(e.access_token=e.accessToken),!e.refreshToken&&e.refresh_token&&(e.refreshToken=e.refresh_token),!e.refresh_token&&e.refreshToken&&(e.refresh_token=e.refreshToken),e.user&&(e.user=p(e.user)),e}function y(t,e){const r=new Error(e?.error||e?.message||`Request failed (${t.status})`);return r.status=t.status,r.data=e,r}async function O(t,e={}){const{method:r="GET",token:n,headers:o={},body:f}=e,i={...o};n&&(i.Authorization=`Bearer ${n}`);const c=await fetch(`${w}${t}`,{method:r,headers:i,body:f}),h=await c.text();let l={};if(h)try{l=JSON.parse(h)}catch{l={}}if(l=A(l),!c.ok)throw y(c,l);return l}function d(t,e,r){return O(t,{method:"POST",token:r,headers:{"Content-Type":"application/json"},body:JSON.stringify(e||{})})}function K(t,e){return O(t,{method:"GET",token:e})}async function F(t){const e=await d("/api/auth/login",{username:String(t.identifier||"").trim(),password:String(t.password||""),loginType:t.useNumber?"user_number":"username"});return{token:String(e?.accessToken||""),refreshToken:String(e?.refreshToken||""),user:p(e?.user)}}async function P(t){const e=await d("/api/auth/register-email",{username:String(t.username||"").trim(),password:String(t.password||""),email:String(t.email||"").trim(),code:String(t.code||"").trim()});return{token:String(e?.accessToken||""),refreshToken:String(e?.refreshToken||""),user:p(e?.user)}}function D(t,e="register"){return d("/api/auth/send-code",{email:String(t||"").trim(),purpose:e})}function x(t){return d("/api/auth/refresh",{refreshToken:String(t||"").trim()})}function _(t){return K("/api/auth/me",t)}function C(t){return d("/api/auth/logout",{refreshToken:String(t||"").trim()})}async function G(t,e,r){const n=new FormData;n.append("file",e);const o=await fetch(`${w}/chat/files/upload`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"X-Room-Id":String(t||"")},body:n}),f=await o.text();let i={};if(f)try{i=JSON.parse(f)}catch{i={}}if(!o.ok)throw y(o,i);return i}function W(t,e,r){const n=new URL(`${w}/chat/files/download/${encodeURIComponent(String(t||""))}`);return e&&n.searchParams.set("roomId",String(e)),r&&n.searchParams.set("token",String(r)),n.toString()}const u={AUTH_TOKEN:"fh:auth:token",REFRESH_TOKEN:"fh:auth:refreshToken",USER:"fh:auth:user"};function k(t){try{return localStorage.getItem(t)}catch{return null}}function m(t,e){try{localStorage.setItem(t,e)}catch{}}function T(t){try{localStorage.removeItem(t)}catch{}}function J(){const t=k(u.USER);if(!t)return null;try{return JSON.parse(t)}catch{return null}}function v(t){if(!t){T(u.USER);return}m(u.USER,JSON.stringify(t))}function j(t){const e=Number(t&&t.status);return e===400||e===401||e===403}const M=H("session",()=>{const t=S(!1),e=S(!1),r=S(k(u.AUTH_TOKEN)||""),n=S(k(u.REFRESH_TOKEN)||""),o=S(J()),f=I(()=>!!(r.value&&o.value));function i(s){r.value=String(s.token||""),n.value=String(s.refreshToken||""),o.value=s.user||null,m(u.AUTH_TOKEN,r.value),n.value&&m(u.REFRESH_TOKEN,n.value),v(o.value)}function c(){r.value="",n.value="",o.value=null,T(u.AUTH_TOKEN),T(u.REFRESH_TOKEN),T(u.USER)}async function h(){if(!n.value)return null;const s=await x(n.value),a=String(s?.accessToken||"");if(!a)return null;r.value=a,m(u.AUTH_TOKEN,r.value),s?.refreshToken&&(n.value=String(s.refreshToken),m(u.REFRESH_TOKEN,n.value));const g=(await _(r.value))?.user||null;return g?(o.value=g,v(o.value),{token:r.value,refreshToken:n.value,user:g}):null}async function l(){if(e.value)return f.value;t.value=!0;try{if(r.value)try{const a=await _(r.value);if(a?.user)return o.value=a.user,v(o.value),e.value=!0,!0}catch(a){if(!j(a))return e.value=!0,!1}return await h()?(e.value=!0,!0):(c(),e.value=!0,!1)}catch{return c(),e.value=!0,!1}finally{t.value=!1}}async function R(s){t.value=!0;try{const a=await F(s);return i(a),e.value=!0,a}finally{t.value=!1}}async function N(s){t.value=!0;try{const a=await P(s);return i(a),e.value=!0,a}finally{t.value=!1}}async function U(){try{const s=await h();return s||c(),s}catch{return c(),null}}async function b(){const s=n.value;if(s)try{await C(s)}catch{}c()}return{loading:t,restored:e,token:r,refreshToken:n,user:o,authed:f,applySession:i,clearSession:c,restoreSession:l,refreshSession:U,login:R,register:N,logout:b}});export{B as W,q as _,G as a,W as c,D as s,M as u};
