import{w as bt,v as Ss}from"./runtime-dom.esm-bundler.Cc_N6hud.js";import{_ as ne,u as ft}from"./session-store.Dd2HyGIM.js";import{h as De,i as y,c as k,a as u,b as M,k as G,d as K,n as fe,l as oe,f as ae,F as U,m as V,t as $,p as xs,w as Cs,o as Es,g as Ts}from"./pinia.GsotNk0y.js";import{W as Rs,a as Ms,g as As,f as X,d as Is,s as ut,b as $s,C as Os}from"./ws-client.fv07f5cr.js";import{T as Ps}from"./ToastHost.CQvuvMz1.js";const Ns=ae({__name:"ChessTopBar",props:{inRoom:{type:Boolean},isOwner:{type:Boolean},showOwnerMenu:{type:Boolean},showChannelDrawer:{type:Boolean}},emits:["toggle-owner-menu","toggle-drawer","open-members","invite","restart","close-room-menu"],setup(i,{expose:e}){e();const t={};return Object.defineProperty(t,"__isScriptSetup",{enumerable:!1,value:!0}),t}}),Ls={class:"shrink-0 border-b z-40",style:{"padding-top":"env(safe-area-inset-top)",background:"var(--surface-1)","border-color":"var(--ink-4)"}},Ks={class:"h-14 flex items-center justify-between px-4 md:px-6"},Ds={class:"flex items-center gap-2"},Fs={href:"/applications",class:"flex items-center gap-1.5 px-2 py-1.5 rounded-lg text-sm font-medium transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--ink-2)"},"aria-label":"返回应用列表"},qs={href:"https://fivehow.com",class:"flex items-center gap-1.5 px-2 py-1.5 rounded-lg text-sm font-medium transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--ink-2)"},"aria-label":"回到主页"},js={class:"flex items-center gap-2 absolute left-1/2 -translate-x-1/2"},Us={class:"flex items-center gap-2"},Bs={key:0,class:"relative"},Hs={key:0,class:"absolute right-0 top-full mt-1 w-48 rounded-xl border p-1.5 z-50 animate-scale-in",style:{background:"var(--surface-1)","border-color":"var(--ink-4)","box-shadow":"var(--shadow-modal)"}};function Js(i,e,t,s,r,n){const a=De("iconify-icon");return y(),k("nav",Ls,[u("div",Ks,[u("div",Ds,[u("a",Fs,[M(a,{icon:"lucide:arrow-left",class:"text-base"}),e[6]||(e[6]=u("span",{class:"hidden md:inline"},"返回",-1))]),u("a",qs,[M(a,{icon:"lucide:home",class:"text-base"}),e[7]||(e[7]=u("span",{class:"hidden md:inline"},"主页",-1))])]),u("div",js,[M(a,{icon:"lucide:crown",class:"text-lg",style:{color:"var(--ink-1)"}}),e[8]||(e[8]=u("span",{class:"text-base font-semibold",style:{color:"var(--ink-0)","font-family":"var(--font-heading)"}},"Chess",-1))]),u("div",Us,[t.isOwner&&t.inRoom?(y(),k("div",Bs,[u("button",{class:"flex items-center gap-1 px-2 py-1.5 rounded-lg text-sm transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--ink-2)"},"aria-label":"棋局管理",onClick:e[0]||(e[0]=o=>i.$emit("toggle-owner-menu"))},[M(a,{icon:"lucide:more-vertical",class:"text-base"})]),t.showOwnerMenu?(y(),k("div",Hs,[e[13]||(e[13]=u("div",{class:"px-3 py-1.5 text-xs font-medium",style:{color:"var(--ink-3)"}},"对局管理",-1)),u("button",{class:"w-full text-left px-3 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--ink-1)"},onClick:e[1]||(e[1]=o=>i.$emit("open-members"))},[M(a,{icon:"lucide:users",class:"text-base"}),e[9]||(e[9]=G(" 移除玩家 ",-1))]),u("button",{class:"w-full text-left px-3 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--ink-1)"},onClick:e[2]||(e[2]=o=>i.$emit("invite"))},[M(a,{icon:"lucide:user-plus",class:"text-base"}),e[10]||(e[10]=G(" 邀请玩家 ",-1))]),u("button",{class:"w-full text-left px-3 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--danger)"},onClick:e[3]||(e[3]=o=>i.$emit("restart"))},[M(a,{icon:"lucide:rotate-ccw",class:"text-base"}),e[11]||(e[11]=G(" 重启棋局 ",-1))]),u("button",{class:"w-full text-left px-3 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--danger)"},onClick:e[4]||(e[4]=o=>i.$emit("close-room-menu"))},[M(a,{icon:"lucide:x-circle",class:"text-base"}),e[12]||(e[12]=G(" 关闭棋局 ",-1))])])):K("",!0)])):K("",!0),u("button",{class:oe(["flex items-center gap-1 px-2 py-1.5 rounded-lg text-sm font-medium transition-colors",{"hover:bg-[var(--surface-2)]":!t.showChannelDrawer}]),style:fe(t.showChannelDrawer?"background: var(--surface-3); color: var(--ink-0)":"color: var(--ink-2)"),"aria-label":"切换频道列表",onClick:e[5]||(e[5]=o=>i.$emit("toggle-drawer"))},[M(a,{icon:"lucide:hash",class:"text-base"}),M(a,{icon:t.showChannelDrawer?"lucide:panel-right-close":"lucide:panel-right-open",class:"text-base hidden md:block"},null,8,["icon"])],6)])])])}const Qs=ne(Ns,[["render",Js]]),Gs=ae({__name:"ChessBoard",props:{boardRows:{},fileLabels:{},pieceUnicode:{type:Function},squareClasses:{type:Function}},emits:["square-click"],setup(i,{expose:e}){e();const t={};return Object.defineProperty(t,"__isScriptSetup",{enumerable:!1,value:!0}),t}}),Vs={class:"w-full max-w-md md:max-w-lg"},Ws={class:"mb-1 px-2 md:px-3 flex justify-between"},zs={class:"rounded-xl overflow-hidden border",style:{"border-color":"var(--ink-4)","box-shadow":"var(--shadow-card)"}},Ys={class:"w-5 md:w-6 flex justify-center text-[10px] md:text-xs",style:{color:"var(--ink-3)"}},Zs={class:"flex-1 grid grid-cols-8"},Xs=["data-sq","onClick"],ei={key:0,class:"chess-piece"},ti={key:1,class:"w-2.5 h-2.5 rounded-full",style:{background:"rgba(0,0,0,0.2)"}},si={class:"w-5 md:w-6 flex justify-center text-[10px] md:text-xs",style:{color:"var(--ink-3)"}},ii={class:"mt-1 px-2 md:px-3 flex justify-between"};function oi(i,e,t,s,r,n){return y(),k("div",Vs,[u("div",Ws,[(y(!0),k(U,null,V(t.fileLabels,a=>(y(),k("span",{key:`top-${a}`,class:"coord-label"},$(a),1))),128))]),u("div",zs,[(y(!0),k(U,null,V(t.boardRows,(a,o)=>(y(),k("div",{key:`rank-${a.label}-${o}`,class:"flex items-center"},[u("div",Ys,$(a.label),1),u("div",Zs,[(y(!0),k(U,null,V(a.squares,d=>(y(),k("button",{key:d.name,class:oe(["relative aspect-square chess-square",t.squareClasses(d)]),"data-sq":d.name,onClick:g=>i.$emit("square-click",d)},[d.piece?(y(),k("span",ei,$(t.pieceUnicode(d.piece)),1)):d.isLegal?(y(),k("span",ti)):K("",!0)],10,Xs))),128))]),u("div",si,$(a.label),1)]))),128))]),u("div",ii,[(y(!0),k(U,null,V(t.fileLabels,a=>(y(),k("span",{key:`bottom-${a}`,class:"coord-label"},$(a),1))),128))])])}const ri=ne(Gs,[["render",oi]]),ni=ae({__name:"ChessPlayersPanel",props:{players:{},myUserId:{},isCurrentTurn:{type:Function},getInitial:{type:Function},getAvatarColor:{type:Function},getCapturedPieces:{type:Function}},setup(i,{expose:e}){e();const t={};return Object.defineProperty(t,"__isScriptSetup",{enumerable:!1,value:!0}),t}}),ai={key:0,class:"grid grid-cols-1 md:grid-cols-2 gap-3 mb-4"},li={class:"text-sm font-semibold",style:{color:"var(--ink-1)"}},ci={class:"min-w-0 flex-1"},hi={class:"flex items-center gap-1.5"},fi={class:"text-sm font-semibold truncate",style:{color:"var(--ink-0)"}},ui={class:"text-xs px-1.5 py-0.5 rounded",style:{color:"var(--ink-2)",background:"var(--surface-2)"}},di={class:"flex items-center gap-1.5 mt-0.5"},mi={key:0,class:"text-xs font-medium",style:{color:"var(--state-green)"}},pi={key:1,class:"text-xs",style:{color:"var(--ink-3)"}},gi={class:"shrink-0 flex flex-wrap gap-0.5 max-w-[4rem]"};function vi(i,e,t,s,r,n){return t.players.length>0?(y(),k("div",ai,[(y(!0),k(U,null,V(t.players,a=>(y(),k("div",{key:a.memberId,class:"flex items-center gap-3 p-3 rounded-xl border transition-all",style:fe(t.isCurrentTurn(a)?"border-color: var(--state-green); background: color-mix(in srgb, var(--state-green) 5%, var(--surface-1))":"border-color: var(--ink-4); background: var(--surface-1)")},[u("div",{class:"w-10 h-10 rounded-full shrink-0 flex items-center justify-center",style:fe(`background:${t.getAvatarColor(a.username)}`)},[u("span",li,$(t.getInitial(a.userId===t.myUserId?"我":a.username)),1)],4),u("div",ci,[u("div",hi,[u("span",fi,$(a.userId===t.myUserId?"我":a.username),1),u("span",ui,$(a.role==="white"?"● 白方":"● 黑方"),1)]),u("div",di,[t.isCurrentTurn(a)?(y(),k("span",mi,[e[0]||(e[0]=u("span",{class:"inline-block w-1.5 h-1.5 rounded-full animate-pulse mr-1",style:{background:"var(--state-green)"}},null,-1)),G(" "+$(a.userId===t.myUserId?"轮到你走":"正在走棋"),1)])):(y(),k("span",pi,[...e[1]||(e[1]=[u("span",{class:"inline-block w-1.5 h-1.5 rounded-full mr-1",style:{background:"var(--state-yellow)"}},null,-1),G(" 等待中 ",-1)])]))])]),u("div",gi,[(y(!0),k(U,null,V(t.getCapturedPieces(a.role==="white"?"w":"b"),(o,d)=>(y(),k("span",{key:`${a.memberId}-cp-${d}`,class:"text-xs opacity-60"},$(o),1))),128))])],4))),128))])):K("",!0)}const _i=ne(ni,[["render",vi]]),bi=ae({__name:"ChessMoveHistory",props:{moves:{}},setup(i,{expose:e}){e();const t={};return Object.defineProperty(t,"__isScriptSetup",{enumerable:!1,value:!0}),t}}),wi={key:0,class:"mt-4 p-3 rounded-xl",style:{background:"var(--surface-2)"}},yi={class:"flex items-center justify-between mb-2"},ki={class:"text-xs",style:{color:"var(--ink-3)"}},Si={class:"flex flex-wrap gap-1.5"};function xi(i,e,t,s,r,n){return t.moves.length>0?(y(),k("div",wi,[u("div",yi,[e[0]||(e[0]=u("span",{class:"text-sm font-medium",style:{color:"var(--ink-1)"}},"走子记录",-1)),u("span",ki,"第 "+$(Math.ceil(t.moves.length/2))+" 回合",1)]),u("div",Si,[(y(!0),k(U,null,V(t.moves,(a,o)=>(y(),k("span",{key:`mv-${o}`,class:oe(["px-2 py-1 rounded-lg text-xs font-medium",o===t.moves.length-1?"move-tag-current":""]),style:fe(o===t.moves.length-1?"":"color: var(--ink-1); background: var(--surface-1);")},$(a.san||`${a.from}-${a.to}`),7))),128))])])):K("",!0)}const Ci=ne(bi,[["render",xi]]),Ei=ae({__name:"ChessDrawer",props:{show:{type:Boolean},inRoom:{type:Boolean},isOwner:{type:Boolean},roomCode:{},joinCode:{}},emits:["close","connect-my-room","join-code","update:join-code","leave-room","close-room"],setup(i,{expose:e}){e();const t={};return Object.defineProperty(t,"__isScriptSetup",{enumerable:!1,value:!0}),t}}),Ti={class:"h-14 md:h-auto md:pt-0 px-4 border-b flex items-center justify-between",style:{"border-color":"var(--ink-4)","padding-top":"env(safe-area-inset-top)"}},Ri={class:"p-3 border-b",style:{"border-color":"var(--ink-4)"}},Mi={class:"flex items-center gap-2"},Ai={key:0,class:"mt-2 px-3 py-2 rounded-lg",style:{background:"var(--surface-2)"}},Ii={class:"text-sm font-medium",style:{color:"var(--ink-0)"}},$i={class:"p-3 border-b",style:{"border-color":"var(--ink-4)"}},Oi={class:"flex gap-2"},Pi=["value"],Ni={class:"p-3"};function Li(i,e,t,s,r,n){const a=De("iconify-icon");return y(),k(U,null,[u("div",{class:oe(["drawer-overlay fixed inset-0 z-40 bg-black/20 md:hidden",t.show?"visible-overlay":"hidden-overlay"]),onClick:e[0]||(e[0]=o=>i.$emit("close"))},null,2),u("aside",{class:oe(["drawer-panel w-[300px] max-w-[82vw] border-l shrink-0 bg-surface-1 h-full fixed md:static right-0 top-0 md:top-auto z-50",t.show?"open":"closed"]),style:{"border-color":"var(--ink-4)"}},[u("div",Ti,[e[8]||(e[8]=u("h3",{class:"text-xl font-semibold",style:{color:"var(--ink-0)","font-family":"var(--font-heading)"}},"棋局频道",-1)),u("button",{class:"md:hidden p-1",style:{color:"var(--ink-2)"},onClick:e[1]||(e[1]=o=>i.$emit("close"))},[M(a,{icon:"lucide:x",class:"text-lg"})])]),u("div",Ri,[e[12]||(e[12]=u("div",{class:"text-xs mb-2",style:{color:"var(--ink-3)"}},"我的棋局",-1)),u("button",{class:"channel-item active w-full text-left px-3 py-2 rounded-lg border-l-2",style:{"border-left-color":"var(--ink-0)"},onClick:e[2]||(e[2]=o=>i.$emit("connect-my-room"))},[u("div",Mi,[M(a,{icon:"lucide:hash",class:"text-sm",style:{color:"var(--ink-2)"}}),e[9]||(e[9]=u("span",{class:"text-sm font-medium",style:{color:"var(--ink-0)"}},"我的棋局",-1))]),e[10]||(e[10]=u("div",{class:"text-xs mt-1",style:{color:"var(--ink-3)"}},"点击进入你的棋局",-1))]),t.inRoom&&!t.isOwner?(y(),k("div",Ai,[e[11]||(e[11]=u("div",{class:"text-xs",style:{color:"var(--ink-3)"}},"当前加入",-1)),u("div",Ii,"# "+$(t.roomCode),1)])):K("",!0)]),u("div",$i,[e[13]||(e[13]=u("div",{class:"text-xs mb-2",style:{color:"var(--ink-3)"}},"加入棋局",-1)),u("div",Oi,[u("input",{value:t.joinCode,type:"text",inputmode:"numeric",maxlength:"18",class:"fh-input flex-1 px-3 py-2 rounded-lg border text-sm outline-none",placeholder:"输入号码",style:{background:"var(--surface-0)","border-color":"var(--ink-4)",color:"var(--ink-0)"},onInput:e[3]||(e[3]=o=>i.$emit("update:join-code",o.target.value)),onKeydown:e[4]||(e[4]=bt(o=>i.$emit("join-code"),["enter"]))},null,40,Pi),u("button",{class:"px-3 py-2 rounded-lg text-sm font-semibold border",style:{"border-color":"var(--ink-4)",color:"var(--ink-1)"},onClick:e[5]||(e[5]=o=>i.$emit("join-code"))}," 加入 ")])]),u("div",Ni,[t.inRoom&&!t.isOwner?(y(),k("button",{key:0,class:"w-full px-3 py-2 rounded-lg text-sm font-medium border",style:{"border-color":"var(--ink-4)",color:"var(--ink-2)"},onClick:e[6]||(e[6]=o=>i.$emit("leave-room"))}," 退出当前棋局 ")):K("",!0),t.inRoom&&t.isOwner?(y(),k("button",{key:1,class:"w-full px-3 py-2 rounded-lg text-sm font-medium border",style:{"border-color":"var(--danger)",color:"var(--danger)"},onClick:e[7]||(e[7]=o=>i.$emit("close-room"))}," 关闭我的棋局 ")):K("",!0)])],2)],64)}const Ki=ne(Ei,[["render",Li]]);function Di(i){return i!==null?{comment:i,variations:[]}:{variations:[]}}function Fi(i,e,t,s,r){const n={move:i,variations:r};return e&&(n.suffix=e),t&&(n.nag=t),s!==null&&(n.comment=s),n}function qi(...i){const[e,...t]=i;let s=e;for(const r of t)r!==null&&(s.variations=[r,...r.variations],r.variations=[],s=r);return e}function ji(i,e){if(e.marker&&e.marker.comment){let t=e.root;for(;;){const s=t.variations[0];if(!s){t.comment=e.marker.comment;break}t=s}}return{headers:i,root:e.root,result:(e.marker&&e.marker.result)??void 0}}function Ui(i,e){function t(){this.constructor=i}t.prototype=e.prototype,i.prototype=new t}function re(i,e,t,s){var r=Error.call(this,i);return Object.setPrototypeOf&&Object.setPrototypeOf(r,re.prototype),r.expected=e,r.found=t,r.location=s,r.name="SyntaxError",r}Ui(re,Error);function Re(i,e,t){return t=t||" ",i.length>e?i:(e-=i.length,t+=t.repeat(e),i+t.slice(0,e))}re.prototype.format=function(i){var e="Error: "+this.message;if(this.location){var t=null,s;for(s=0;s<i.length;s++)if(i[s].source===this.location.source){t=i[s].text.split(/\r\n|\n|\r/g);break}var r=this.location.start,n=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(r):r,a=this.location.source+":"+n.line+":"+n.column;if(t){var o=this.location.end,d=Re("",n.line.toString().length," "),g=t[r.line-1],v=r.line===o.line?o.column:g.length+1,E=v-r.column||1;e+=`
 --> `+a+`
`+d+` |
`+n.line+" | "+g+`
`+d+" | "+Re("",r.column-1," ")+Re("",E,"^")}else e+=`
 at `+a}return e};re.buildMessage=function(i,e){var t={literal:function(g){return'"'+r(g.text)+'"'},class:function(g){var v=g.parts.map(function(E){return Array.isArray(E)?n(E[0])+"-"+n(E[1]):n(E)});return"["+(g.inverted?"^":"")+v.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(g){return g.description}};function s(g){return g.charCodeAt(0).toString(16).toUpperCase()}function r(g){return g.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(v){return"\\x0"+s(v)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(v){return"\\x"+s(v)})}function n(g){return g.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(v){return"\\x0"+s(v)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(v){return"\\x"+s(v)})}function a(g){return t[g.type](g)}function o(g){var v=g.map(a),E,p;if(v.sort(),v.length>0){for(E=1,p=1;E<v.length;E++)v[E-1]!==v[E]&&(v[p]=v[E],p++);v.length=p}switch(v.length){case 1:return v[0];case 2:return v[0]+" or "+v[1];default:return v.slice(0,-1).join(", ")+", or "+v[v.length-1]}}function d(g){return g?'"'+r(g)+'"':"end of input"}return"Expected "+o(i)+" but "+d(e)+" found."};function Bi(i,e){e=e!==void 0?e:{};var t={},s=e.grammarSource,r={pgn:rt},n=rt,a="[",o='"',d="]",g=".",v="O-O-O",E="O-O",p="0-0-0",S="0-0",T="$",A="{",Q="}",Se=";",xe="(",yt=")",Fe="1-0",qe="0-1",je="1/2-1/2",kt="*",Ce=/^[a-zA-Z]/,Ue=/^[^"]/,de=/^[0-9]/,Be=/^[.]/,He=/^[a-zA-Z1-8\-=]/,St=/^[+#]/,Je=/^[!?]/,Qe=/^[^}]/,Ge=/^[^\r\n]/,Ve=/^[ \t\r\n]/,xt=B("tag pair"),Ct=N("[",!1),We=N('"',!1),Et=N("]",!1),Tt=B("tag name"),Ee=J([["a","z"],["A","Z"]],!1,!1),Rt=B("tag value"),ze=J(['"'],!0,!1),Mt=B("move number"),me=J([["0","9"]],!1,!1),At=N(".",!1),Ye=J(["."],!1,!1),It=B("standard algebraic notation"),$t=N("O-O-O",!1),Ot=N("O-O",!1),Pt=N("0-0-0",!1),Nt=N("0-0",!1),Ze=J([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),Lt=J(["+","#"],!1,!1),Kt=B("suffix annotation"),Xe=J(["!","?"],!1,!1),Dt=B("NAG"),Ft=N("$",!1),qt=B("brace comment"),jt=N("{",!1),et=J(["}"],!0,!1),Ut=N("}",!1),Bt=B("rest of line comment"),Ht=N(";",!1),tt=J(["\r",`
`],!0,!1),Jt=B("variation"),Qt=N("(",!1),Gt=N(")",!1),Vt=B("game termination marker"),Wt=N("1-0",!1),zt=N("0-1",!1),Yt=N("1/2-1/2",!1),Zt=N("*",!1),Xt=B("whitespace"),st=J([" ","	","\r",`
`],!1,!1),es=function(l,h){return ji(l,h)},ts=function(l){return Object.fromEntries(l)},ss=function(l,h){return[l,h]},is=function(l,h){return{root:l,marker:h}},os=function(l,h){return qi(Di(l),...h.flat())},rs=function(l,h,f,b,w){return Fi(l,h,f,b,w)},ns=function(l){return l},as=function(l){return l.replace(/[\r\n]+/g," ")},ls=function(l){return l.trim()},cs=function(l){return l},hs=function(l,h){return{result:l,comment:h}},c=e.peg$currPos|0,se=[{line:1,column:1}],H=c,pe=e.peg$maxFailExpected||[],m=e.peg$silentFails|0,le;if(e.startRule){if(!(e.startRule in r))throw new Error(`Can't start parsing from rule "`+e.startRule+'".');n=r[e.startRule]}function N(l,h){return{type:"literal",text:l,ignoreCase:h}}function J(l,h,f){return{type:"class",parts:l,inverted:h,ignoreCase:f}}function fs(){return{type:"end"}}function B(l){return{type:"other",description:l}}function it(l){var h=se[l],f;if(h)return h;if(l>=se.length)f=se.length-1;else for(f=l;!se[--f];);for(h=se[f],h={line:h.line,column:h.column};f<l;)i.charCodeAt(f)===10?(h.line++,h.column=1):h.column++,f++;return se[l]=h,h}function ot(l,h,f){var b=it(l),w=it(h),R={source:s,start:{offset:l,line:b.line,column:b.column},end:{offset:h,line:w.line,column:w.column}};return R}function _(l){c<H||(c>H&&(H=c,pe=[]),pe.push(l))}function us(l,h,f){return new re(re.buildMessage(l,h),l,h,f)}function rt(){var l,h,f;return l=c,h=ds(),f=gs(),l=es(h,f),l}function ds(){var l,h,f;for(l=c,h=[],f=nt();f!==t;)h.push(f),f=nt();return f=q(),l=ts(h),l}function nt(){var l,h,f,b,w,R,Z;return m++,l=c,q(),i.charCodeAt(c)===91?(h=a,c++):(h=t,m===0&&_(Ct)),h!==t?(q(),f=ms(),f!==t?(q(),i.charCodeAt(c)===34?(b=o,c++):(b=t,m===0&&_(We)),b!==t?(w=ps(),i.charCodeAt(c)===34?(R=o,c++):(R=t,m===0&&_(We)),R!==t?(q(),i.charCodeAt(c)===93?(Z=d,c++):(Z=t,m===0&&_(Et)),Z!==t?l=ss(f,w):(c=l,l=t)):(c=l,l=t)):(c=l,l=t)):(c=l,l=t)):(c=l,l=t),m--,l===t&&m===0&&_(xt),l}function ms(){var l,h,f;if(m++,l=c,h=[],f=i.charAt(c),Ce.test(f)?c++:(f=t,m===0&&_(Ee)),f!==t)for(;f!==t;)h.push(f),f=i.charAt(c),Ce.test(f)?c++:(f=t,m===0&&_(Ee));else h=t;return h!==t?l=i.substring(l,c):l=h,m--,l===t&&(h=t,m===0&&_(Tt)),l}function ps(){var l,h,f;for(m++,l=c,h=[],f=i.charAt(c),Ue.test(f)?c++:(f=t,m===0&&_(ze));f!==t;)h.push(f),f=i.charAt(c),Ue.test(f)?c++:(f=t,m===0&&_(ze));return l=i.substring(l,c),m--,h=t,m===0&&_(Rt),l}function gs(){var l,h,f;return l=c,h=at(),q(),f=ks(),f===t&&(f=null),q(),l=is(h,f),l}function at(){var l,h,f,b;for(l=c,h=Te(),h===t&&(h=null),f=[],b=lt();b!==t;)f.push(b),b=lt();return l=os(h,f),l}function lt(){var l,h,f,b,w,R,Z,ge;if(l=c,q(),vs(),q(),h=_s(),h!==t){for(f=bs(),f===t&&(f=null),b=[],w=ct();w!==t;)b.push(w),w=ct();for(w=q(),R=Te(),R===t&&(R=null),Z=[],ge=ht();ge!==t;)Z.push(ge),ge=ht();l=rs(h,f,b,R,Z)}else c=l,l=t;return l}function vs(){var l,h,f,b,w,R;for(m++,l=c,h=[],f=i.charAt(c),de.test(f)?c++:(f=t,m===0&&_(me));f!==t;)h.push(f),f=i.charAt(c),de.test(f)?c++:(f=t,m===0&&_(me));if(i.charCodeAt(c)===46?(f=g,c++):(f=t,m===0&&_(At)),f!==t){for(b=q(),w=[],R=i.charAt(c),Be.test(R)?c++:(R=t,m===0&&_(Ye));R!==t;)w.push(R),R=i.charAt(c),Be.test(R)?c++:(R=t,m===0&&_(Ye));h=[h,f,b,w],l=h}else c=l,l=t;return m--,l===t&&(h=t,m===0&&_(Mt)),l}function _s(){var l,h,f,b,w,R;if(m++,l=c,h=c,i.substr(c,5)===v?(f=v,c+=5):(f=t,m===0&&_($t)),f===t&&(i.substr(c,3)===E?(f=E,c+=3):(f=t,m===0&&_(Ot)),f===t&&(i.substr(c,5)===p?(f=p,c+=5):(f=t,m===0&&_(Pt)),f===t&&(i.substr(c,3)===S?(f=S,c+=3):(f=t,m===0&&_(Nt)),f===t))))if(f=c,b=i.charAt(c),Ce.test(b)?c++:(b=t,m===0&&_(Ee)),b!==t){if(w=[],R=i.charAt(c),He.test(R)?c++:(R=t,m===0&&_(Ze)),R!==t)for(;R!==t;)w.push(R),R=i.charAt(c),He.test(R)?c++:(R=t,m===0&&_(Ze));else w=t;w!==t?(b=[b,w],f=b):(c=f,f=t)}else c=f,f=t;return f!==t?(b=i.charAt(c),St.test(b)?c++:(b=t,m===0&&_(Lt)),b===t&&(b=null),f=[f,b],h=f):(c=h,h=t),h!==t?l=i.substring(l,c):l=h,m--,l===t&&(h=t,m===0&&_(It)),l}function bs(){var l,h,f;for(m++,l=c,h=[],f=i.charAt(c),Je.test(f)?c++:(f=t,m===0&&_(Xe));f!==t;)h.push(f),h.length>=2?f=t:(f=i.charAt(c),Je.test(f)?c++:(f=t,m===0&&_(Xe)));return h.length<1?(c=l,l=t):l=h,m--,l===t&&(h=t,m===0&&_(Kt)),l}function ct(){var l,h,f,b,w;if(m++,l=c,q(),i.charCodeAt(c)===36?(h=T,c++):(h=t,m===0&&_(Ft)),h!==t){if(f=c,b=[],w=i.charAt(c),de.test(w)?c++:(w=t,m===0&&_(me)),w!==t)for(;w!==t;)b.push(w),w=i.charAt(c),de.test(w)?c++:(w=t,m===0&&_(me));else b=t;b!==t?f=i.substring(f,c):f=b,f!==t?l=ns(f):(c=l,l=t)}else c=l,l=t;return m--,l===t&&m===0&&_(Dt),l}function Te(){var l;return l=ws(),l===t&&(l=ys()),l}function ws(){var l,h,f,b,w;if(m++,l=c,i.charCodeAt(c)===123?(h=A,c++):(h=t,m===0&&_(jt)),h!==t){for(f=c,b=[],w=i.charAt(c),Qe.test(w)?c++:(w=t,m===0&&_(et));w!==t;)b.push(w),w=i.charAt(c),Qe.test(w)?c++:(w=t,m===0&&_(et));f=i.substring(f,c),i.charCodeAt(c)===125?(b=Q,c++):(b=t,m===0&&_(Ut)),b!==t?l=as(f):(c=l,l=t)}else c=l,l=t;return m--,l===t&&(h=t,m===0&&_(qt)),l}function ys(){var l,h,f,b,w;if(m++,l=c,i.charCodeAt(c)===59?(h=Se,c++):(h=t,m===0&&_(Ht)),h!==t){for(f=c,b=[],w=i.charAt(c),Ge.test(w)?c++:(w=t,m===0&&_(tt));w!==t;)b.push(w),w=i.charAt(c),Ge.test(w)?c++:(w=t,m===0&&_(tt));f=i.substring(f,c),l=ls(f)}else c=l,l=t;return m--,l===t&&(h=t,m===0&&_(Bt)),l}function ht(){var l,h,f,b;return m++,l=c,q(),i.charCodeAt(c)===40?(h=xe,c++):(h=t,m===0&&_(Qt)),h!==t?(f=at(),f!==t?(q(),i.charCodeAt(c)===41?(b=yt,c++):(b=t,m===0&&_(Gt)),b!==t?l=cs(f):(c=l,l=t)):(c=l,l=t)):(c=l,l=t),m--,l===t&&m===0&&_(Jt),l}function ks(){var l,h,f;return m++,l=c,i.substr(c,3)===Fe?(h=Fe,c+=3):(h=t,m===0&&_(Wt)),h===t&&(i.substr(c,3)===qe?(h=qe,c+=3):(h=t,m===0&&_(zt)),h===t&&(i.substr(c,7)===je?(h=je,c+=7):(h=t,m===0&&_(Yt)),h===t&&(i.charCodeAt(c)===42?(h=kt,c++):(h=t,m===0&&_(Zt))))),h!==t?(q(),f=Te(),f===t&&(f=null),l=hs(h,f)):(c=l,l=t),m--,l===t&&(h=t,m===0&&_(Vt)),l}function q(){var l,h;for(m++,l=[],h=i.charAt(c),Ve.test(h)?c++:(h=t,m===0&&_(st));h!==t;)l.push(h),h=i.charAt(c),Ve.test(h)?c++:(h=t,m===0&&_(st));return m--,h=t,m===0&&_(Xt),l}if(le=n(),e.peg$library)return{peg$result:le,peg$currPos:c,peg$FAILED:t,peg$maxFailExpected:pe,peg$maxFailPos:H};if(le!==t&&c===i.length)return le;throw le!==t&&c<i.length&&_(fs()),us(pe,H<i.length?i.charAt(H):null,H<i.length?ot(H,H+1):ot(H,H))}/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const we=0xffffffffffffffffn;function Me(i,e){return(i<<e|i>>64n-e)&0xffffffffffffffffn}function dt(i,e){return i*e&we}function Hi(i){return function(){let e=BigInt(i&we),t=BigInt(i>>64n&we);const s=dt(Me(dt(e,5n),7n),9n);return t^=e,e=(Me(e,24n)^t^t<<16n)&we,t=Me(t,37n),i=t<<64n|e,s}}const ke=Hi(0xa187eb39cdcaed8f31c4b365b102e01en),Ji=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>ke()))),Qi=Array.from({length:8},()=>ke()),Gi=Array.from({length:16},()=>ke()),Ae=ke(),F="w",j="b",O="p",Ne="n",ye="b",he="r",Y="q",P="k",Ie="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class ve{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(e,t){const{color:s,piece:r,from:n,to:a,flags:o,captured:d,promotion:g}=t,v=L(n),E=L(a);this.color=s,this.piece=r,this.from=v,this.to=E,this.san=e._moveToSan(t,e._moves({legal:!0})),this.lan=v+E,this.before=e.fen(),e._makeMove(t),this.after=e.fen(),e._undoMove(),this.flags="";for(const p in C)C[p]&o&&(this.flags+=ee[p]);d&&(this.captured=d),g&&(this.promotion=g,this.lan+=g)}isCapture(){return this.flags.indexOf(ee.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(ee.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(ee.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(ee.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(ee.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(ee.BIG_PAWN)>-1}}const D=-1,ee={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},C={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},Le={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},Vi={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},Wi={...Le,...Vi},x={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},$e={b:[16,32,17,15],w:[-16,-32,-17,-15]},mt={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},zi=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Yi=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Zi={p:1,n:2,b:4,r:8,q:16,k:32},Xi="pnbrqkPNBRQK",pt=[Ne,ye,he,Y],eo=7,to=6,so=1,io=0,_e={[P]:C.KSIDE_CASTLE,[Y]:C.QSIDE_CASTLE},W={w:[{square:x.a1,flag:C.QSIDE_CASTLE},{square:x.h1,flag:C.KSIDE_CASTLE}],b:[{square:x.a8,flag:C.QSIDE_CASTLE},{square:x.h8,flag:C.KSIDE_CASTLE}]},oo={b:so,w:to},Oe="--";function te(i){return i>>4}function ue(i){return i&15}function wt(i){return"0123456789".indexOf(i)!==-1}function L(i){const e=ue(i),t=te(i);return"abcdefgh".substring(e,e+1)+"87654321".substring(t,t+1)}function ce(i){return i===F?j:F}function ro(i){const e=i.split(/\s+/);if(e.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const t=parseInt(e[5],10);if(isNaN(t)||t<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(e[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(e[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(e[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(e[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const r=e[0].split("/");if(r.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let a=0;a<r.length;a++){let o=0,d=!1;for(let g=0;g<r[a].length;g++)if(wt(r[a][g])){if(d)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};o+=parseInt(r[a][g],10),d=!0}else{if(!/^[prnbqkPRNBQK]$/.test(r[a][g]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};o+=1,d=!1}if(o!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(e[3][1]=="3"&&e[1]=="w"||e[3][1]=="6"&&e[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const n=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:a,regex:o}of n){if(!o.test(e[0]))return{ok:!1,error:`Invalid FEN: missing ${a} king`};if((e[0].match(o)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${a} kings`}}return Array.from(r[0]+r[7]).some(a=>a.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function no(i,e){const t=i.from,s=i.to,r=i.piece;let n=0,a=0,o=0;for(let d=0,g=e.length;d<g;d++){const v=e[d].from,E=e[d].to,p=e[d].piece;r===p&&t!==v&&s===E&&(n++,te(t)===te(v)&&a++,ue(t)===ue(v)&&o++)}return n>0?a>0&&o>0?L(t):o>0?L(t).charAt(1):L(t).charAt(0):""}function z(i,e,t,s,r,n=void 0,a=C.NORMAL){const o=te(s);if(r===O&&(o===eo||o===io))for(let d=0;d<pt.length;d++){const g=pt[d];i.push({color:e,from:t,to:s,piece:r,captured:n,promotion:g,flags:a|C.PROMOTION})}else i.push({color:e,from:t,to:s,piece:r,captured:n,flags:a})}function gt(i){let e=i.charAt(0);return e>="a"&&e<="h"?i.match(/[a-h]\d.*[a-h]\d/)?void 0:O:(e=e.toLowerCase(),e==="o"?P:e)}function Pe(i){return i.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class Ke{_board=new Array(128);_turn=F;_header={};_kings={w:D,b:D};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(e=Ie,{skipValidation:t=!1}={}){this.load(e,{skipValidation:t})}clear({preserveHeaders:e=!1}={}){this._board=new Array(128),this._kings={w:D,b:D},this._turn=F,this._castling={w:0,b:0},this._epSquare=D,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{...Wi},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(e,{skipValidation:t=!1,preserveHeaders:s=!1}={}){let r=e.split(/\s+/);if(r.length>=2&&r.length<6){const o=["-","-","0","1"];e=r.concat(o.slice(-(6-r.length))).join(" ")}if(r=e.split(/\s+/),!t){const{ok:o,error:d}=ro(e);if(!o)throw new Error(d)}const n=r[0];let a=0;this.clear({preserveHeaders:s});for(let o=0;o<n.length;o++){const d=n.charAt(o);if(d==="/")a+=8;else if(wt(d))a+=parseInt(d,10);else{const g=d<"a"?F:j;this._put({type:d.toLowerCase(),color:g},L(a)),a++}}this._turn=r[1],r[2].indexOf("K")>-1&&(this._castling.w|=C.KSIDE_CASTLE),r[2].indexOf("Q")>-1&&(this._castling.w|=C.QSIDE_CASTLE),r[2].indexOf("k")>-1&&(this._castling.b|=C.KSIDE_CASTLE),r[2].indexOf("q")>-1&&(this._castling.b|=C.QSIDE_CASTLE),this._epSquare=r[3]==="-"?D:x[r[3]],this._halfMoves=parseInt(r[4],10),this._moveNumber=parseInt(r[5],10),this._hash=this._computeHash(),this._updateSetup(e),this._incPositionCount()}fen({forceEnpassantSquare:e=!1}={}){let t=0,s="";for(let a=x.a8;a<=x.h1;a++){if(this._board[a]){t>0&&(s+=t,t=0);const{color:o,type:d}=this._board[a];s+=o===F?d.toUpperCase():d.toLowerCase()}else t++;a+1&136&&(t>0&&(s+=t),a!==x.h1&&(s+="/"),t=0,a+=8)}let r="";this._castling[F]&C.KSIDE_CASTLE&&(r+="K"),this._castling[F]&C.QSIDE_CASTLE&&(r+="Q"),this._castling[j]&C.KSIDE_CASTLE&&(r+="k"),this._castling[j]&C.QSIDE_CASTLE&&(r+="q"),r=r||"-";let n="-";if(this._epSquare!==D)if(e)n=L(this._epSquare);else{const a=this._epSquare+(this._turn===F?16:-16),o=[a+1,a-1];for(const d of o){if(d&136)continue;const g=this._turn;if(this._board[d]?.color===g&&this._board[d]?.type===O){this._makeMove({color:g,from:d,to:this._epSquare,piece:O,captured:O,flags:C.EP_CAPTURE});const v=!this._isKingAttacked(g);if(this._undoMove(),v){n=L(this._epSquare);break}}}}return[s,this._turn,r,n,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(e){if(!this._board[e])return 0n;const{color:t,type:s}=this._board[e],r={w:0,b:1}[t],n={p:0,n:1,b:2,r:3,q:4,k:5}[s];return Ji[r][n][e]}_epKey(){return this._epSquare===D?0n:Qi[this._epSquare&7]}_castlingKey(){const e=this._castling.w>>5|this._castling.b>>3;return Gi[e]}_computeHash(){let e=0n;for(let t=x.a8;t<=x.h1;t++){if(t&136){t+=7;continue}this._board[t]&&(e^=this._pieceKey(t))}return e^=this._epKey(),e^=this._castlingKey(),this._turn==="b"&&(e^=Ae),e}_updateSetup(e){this._history.length>0||(e!==Ie?(this._header.SetUp="1",this._header.FEN=e):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(Ie)}get(e){return this._board[x[e]]}findPiece(e){const t=[];for(let s=x.a8;s<=x.h1;s++){if(s&136){s+=7;continue}!this._board[s]||this._board[s]?.color!==e.color||this._board[s].color===e.color&&this._board[s].type===e.type&&t.push(L(s))}return t}put({type:e,color:t},s){return this._put({type:e,color:t},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(e,t){this._hash^=this._pieceKey(e),this._board[e]=t,this._hash^=this._pieceKey(e)}_put({type:e,color:t},s){if(Xi.indexOf(e.toLowerCase())===-1||!(s in x))return!1;const r=x[s];if(e==P&&!(this._kings[t]==D||this._kings[t]==r))return!1;const n=this._board[r];return n&&n.type===P&&(this._kings[n.color]=D),this._set(r,{type:e,color:t}),e===P&&(this._kings[t]=r),!0}_clear(e){this._hash^=this._pieceKey(e),delete this._board[e]}remove(e){const t=this.get(e);return this._clear(x[e]),t&&t.type===P&&(this._kings[t.color]=D),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),t}_updateCastlingRights(){this._hash^=this._castlingKey();const e=this._board[x.e1]?.type===P&&this._board[x.e1]?.color===F,t=this._board[x.e8]?.type===P&&this._board[x.e8]?.color===j;(!e||this._board[x.a1]?.type!==he||this._board[x.a1]?.color!==F)&&(this._castling.w&=-65),(!e||this._board[x.h1]?.type!==he||this._board[x.h1]?.color!==F)&&(this._castling.w&=-33),(!t||this._board[x.a8]?.type!==he||this._board[x.a8]?.color!==j)&&(this._castling.b&=-65),(!t||this._board[x.h8]?.type!==he||this._board[x.h8]?.color!==j)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===D)return;const e=this._epSquare+(this._turn===F?-16:16),t=this._epSquare+(this._turn===F?16:-16),s=[t+1,t-1];if(this._board[e]!==null||this._board[this._epSquare]!==null||this._board[t]?.color!==ce(this._turn)||this._board[t]?.type!==O){this._hash^=this._epKey(),this._epSquare=D;return}const r=n=>!(n&136)&&this._board[n]?.color===this._turn&&this._board[n]?.type===O;s.some(r)||(this._hash^=this._epKey(),this._epSquare=D)}_attacked(e,t,s){const r=[];for(let n=x.a8;n<=x.h1;n++){if(n&136){n+=7;continue}if(this._board[n]===void 0||this._board[n].color!==e)continue;const a=this._board[n],o=n-t;if(o===0)continue;const d=o+119;if(zi[d]&Zi[a.type]){if(a.type===O){if(o>0&&a.color===F||o<=0&&a.color===j)if(s)r.push(L(n));else return!0;continue}if(a.type==="n"||a.type==="k")if(s){r.push(L(n));continue}else return!0;const g=Yi[d];let v=n+g,E=!1;for(;v!==t;){if(this._board[v]!=null){E=!0;break}v+=g}if(!E)if(s){r.push(L(n));continue}else return!0}}return s?r:!1}attackers(e,t){return t?this._attacked(t,x[e],!0):this._attacked(this._turn,x[e],!0)}_isKingAttacked(e){const t=this._kings[e];return t===-1?!1:this._attacked(ce(e),t)}hash(){return this._hash.toString(16)}isAttacked(e,t){return this._attacked(t,x[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const e={b:0,n:0,r:0,q:0,k:0,p:0},t=[];let s=0,r=0;for(let n=x.a8;n<=x.h1;n++){if(r=(r+1)%2,n&136){n+=7;continue}const a=this._board[n];a&&(e[a.type]=a.type in e?e[a.type]+1:1,a.type===ye&&t.push(r),s++)}if(s===2)return!0;if(s===3&&(e[ye]===1||e[Ne]===1))return!0;if(s===e[ye]+2){let n=0;const a=t.length;for(let o=0;o<a;o++)n+=t[o];if(n===0||n===a)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:e=!1,square:t=void 0,piece:s=void 0}={}){const r=this._moves({square:t,piece:s});return e?r.map(n=>new ve(this,n)):r.map(n=>this._moveToSan(n,r))}_moves({legal:e=!0,piece:t=void 0,square:s=void 0}={}){const r=s?s.toLowerCase():void 0,n=t?.toLowerCase(),a=[],o=this._turn,d=ce(o);let g=x.a8,v=x.h1,E=!1;if(r)if(r in x)g=v=x[r],E=!0;else return[];for(let S=g;S<=v;S++){if(S&136){S+=7;continue}if(!this._board[S]||this._board[S].color===d)continue;const{type:T}=this._board[S];let A;if(T===O){if(n&&n!==T)continue;A=S+$e[o][0],this._board[A]||(z(a,o,S,A,O),A=S+$e[o][1],oo[o]===te(S)&&!this._board[A]&&z(a,o,S,A,O,void 0,C.BIG_PAWN));for(let Q=2;Q<4;Q++)A=S+$e[o][Q],!(A&136)&&(this._board[A]?.color===d?z(a,o,S,A,O,this._board[A].type,C.CAPTURE):A===this._epSquare&&z(a,o,S,A,O,O,C.EP_CAPTURE))}else{if(n&&n!==T)continue;for(let Q=0,Se=mt[T].length;Q<Se;Q++){const xe=mt[T][Q];for(A=S;A+=xe,!(A&136);){if(!this._board[A])z(a,o,S,A,T);else{if(this._board[A].color===o)break;z(a,o,S,A,T,this._board[A].type,C.CAPTURE);break}if(T===Ne||T===P)break}}}}if((n===void 0||n===P)&&(!E||v===this._kings[o])){if(this._castling[o]&C.KSIDE_CASTLE){const S=this._kings[o],T=S+2;!this._board[S+1]&&!this._board[T]&&!this._attacked(d,this._kings[o])&&!this._attacked(d,S+1)&&!this._attacked(d,T)&&z(a,o,this._kings[o],T,P,void 0,C.KSIDE_CASTLE)}if(this._castling[o]&C.QSIDE_CASTLE){const S=this._kings[o],T=S-2;!this._board[S-1]&&!this._board[S-2]&&!this._board[S-3]&&!this._attacked(d,this._kings[o])&&!this._attacked(d,S-1)&&!this._attacked(d,T)&&z(a,o,this._kings[o],T,P,void 0,C.QSIDE_CASTLE)}}if(!e||this._kings[o]===-1)return a;const p=[];for(let S=0,T=a.length;S<T;S++)this._makeMove(a[S]),this._isKingAttacked(o)||p.push(a[S]),this._undoMove();return p}move(e,{strict:t=!1}={}){let s=null;if(typeof e=="string")s=this._moveFromSan(e,t);else if(e===null)s=this._moveFromSan(Oe,t);else if(typeof e=="object"){const n=this._moves();for(let a=0,o=n.length;a<o;a++)if(e.from===L(n[a].from)&&e.to===L(n[a].to)&&(!("promotion"in n[a])||e.promotion===n[a].promotion)){s=n[a];break}}if(!s)throw typeof e=="string"?new Error(`Invalid move: ${e}`):new Error(`Invalid move: ${JSON.stringify(e)}`);if(this.isCheck()&&s.flags&C.NULL_MOVE)throw new Error("Null move not allowed when in check");const r=new ve(this,s);return this._makeMove(s),this._incPositionCount(),r}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(e,t){this._hash^=this._pieceKey(e),this._board[t]=this._board[e],delete this._board[e],this._hash^=this._pieceKey(t)}_makeMove(e){const t=this._turn,s=ce(t);if(this._push(e),e.flags&C.NULL_MOVE){t===j&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=D;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),e.captured&&(this._hash^=this._pieceKey(e.to)),this._movePiece(e.from,e.to),e.flags&C.EP_CAPTURE&&(this._turn===j?this._clear(e.to-16):this._clear(e.to+16)),e.promotion&&(this._clear(e.to),this._set(e.to,{type:e.promotion,color:t})),this._board[e.to].type===P){if(this._kings[t]=e.to,e.flags&C.KSIDE_CASTLE){const r=e.to-1,n=e.to+1;this._movePiece(n,r)}else if(e.flags&C.QSIDE_CASTLE){const r=e.to+1,n=e.to-2;this._movePiece(n,r)}this._castling[t]=0}if(this._castling[t]){for(let r=0,n=W[t].length;r<n;r++)if(e.from===W[t][r].square&&this._castling[t]&W[t][r].flag){this._castling[t]^=W[t][r].flag;break}}if(this._castling[s]){for(let r=0,n=W[s].length;r<n;r++)if(e.to===W[s][r].square&&this._castling[s]&W[s][r].flag){this._castling[s]^=W[s][r].flag;break}}if(this._hash^=this._castlingKey(),e.flags&C.BIG_PAWN){let r;t===j?r=e.to-16:r=e.to+16,!(e.to-1&136)&&this._board[e.to-1]?.type===O&&this._board[e.to-1]?.color===s||!(e.to+1&136)&&this._board[e.to+1]?.type===O&&this._board[e.to+1]?.color===s?(this._epSquare=r,this._hash^=this._epKey()):this._epSquare=D}else this._epSquare=D;e.piece===O?this._halfMoves=0:e.flags&(C.CAPTURE|C.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,t===j&&this._moveNumber++,this._turn=s,this._hash^=Ae}undo(){const e=this._hash,t=this._undoMove();if(t){const s=new ve(this,t);return this._decPositionCount(e),s}return null}_undoMove(){const e=this._history.pop();if(e===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const t=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=Ae;const s=this._turn,r=ce(s);if(t.flags&C.NULL_MOVE)return t;if(this._movePiece(t.to,t.from),t.piece&&(this._clear(t.from),this._set(t.from,{type:t.piece,color:s})),t.captured)if(t.flags&C.EP_CAPTURE){let n;s===j?n=t.to-16:n=t.to+16,this._set(n,{type:O,color:r})}else this._set(t.to,{type:t.captured,color:r});if(t.flags&(C.KSIDE_CASTLE|C.QSIDE_CASTLE)){let n,a;t.flags&C.KSIDE_CASTLE?(n=t.to+1,a=t.to-1):(n=t.to-2,a=t.to+1),this._movePiece(a,n)}return t}pgn({newline:e=`
`,maxWidth:t=0}={}){const s=[];let r=!1;for(const p in this._header)this._header[p]&&s.push(`[${p} "${this._header[p]}"]`+e),r=!0;r&&this._history.length&&s.push(e);const n=p=>{const S=this._comments[this.fen()];if(typeof S<"u"){const T=p.length>0?" ":"";p=`${p}${T}{${S}}`}return p},a=[];for(;this._history.length>0;)a.push(this._undoMove());const o=[];let d="";for(a.length===0&&o.push(n(""));a.length>0;){d=n(d);const p=a.pop();if(!p)break;if(!this._history.length&&p.color==="b"){const S=`${this._moveNumber}. ...`;d=d?`${d} ${S}`:S}else p.color==="w"&&(d.length&&o.push(d),d=this._moveNumber+".");d=d+" "+this._moveToSan(p,this._moves({legal:!0})),this._makeMove(p)}if(d.length&&o.push(n(d)),o.push(this._header.Result||"*"),t===0)return s.join("")+o.join(" ");const g=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},v=function(p,S){for(const T of S.split(" "))if(T){if(p+T.length>t){for(;g();)p--;s.push(e),p=0}s.push(T),p+=T.length,s.push(" "),p++}return g()&&p--,p};let E=0;for(let p=0;p<o.length;p++){if(E+o[p].length>t&&o[p].includes("{")){E=v(E,o[p]);continue}E+o[p].length>t&&p!==0?(s[s.length-1]===" "&&s.pop(),s.push(e),E=0):p!==0&&(s.push(" "),E++),s.push(o[p]),E+=o[p].length}return s.join("")}header(...e){for(let t=0;t<e.length;t+=2)typeof e[t]=="string"&&typeof e[t+1]=="string"&&(this._header[e[t]]=e[t+1]);return this._header}setHeader(e,t){return this._header[e]=t??Le[e]??null,this.getHeaders()}removeHeader(e){return e in this._header?(this._header[e]=Le[e]||null,!0):!1}getHeaders(){const e={};for(const[t,s]of Object.entries(this._header))s!==null&&(e[t]=s);return e}loadPgn(e,{strict:t=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(e=e.replace(new RegExp(s,"g"),`
`));const r=Bi(e);this.reset();const n=r.headers;let a="";for(const g in n)g.toLowerCase()==="fen"&&(a=n[g]),this.header(g,n[g]);if(!t)a&&this.load(a,{preserveHeaders:!0});else if(n.SetUp==="1"){if(!("FEN"in n))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(n.FEN,{preserveHeaders:!0})}let o=r.root;for(;o;){if(o.move){const g=this._moveFromSan(o.move,t);if(g==null)throw new Error(`Invalid move in PGN: ${o.move}`);this._makeMove(g),this._incPositionCount()}o.comment!==void 0&&(this._comments[this.fen()]=o.comment),o=o.variations[0]}const d=r.result;d&&Object.keys(this._header).length&&this._header.Result!==d&&this.setHeader("Result",d)}_moveToSan(e,t){let s="";if(e.flags&C.KSIDE_CASTLE)s="O-O";else if(e.flags&C.QSIDE_CASTLE)s="O-O-O";else{if(e.flags&C.NULL_MOVE)return Oe;if(e.piece!==O){const r=no(e,t);s+=e.piece.toUpperCase()+r}e.flags&(C.CAPTURE|C.EP_CAPTURE)&&(e.piece===O&&(s+=L(e.from)[0]),s+="x"),s+=L(e.to),e.promotion&&(s+="="+e.promotion.toUpperCase())}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(e,t=!1){let s=Pe(e);if(t||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==Oe)return{color:this._turn,from:0,to:0,piece:"k",flags:C.NULL_MOVE};let r=gt(s),n=this._moves({legal:!0,piece:r});for(let p=0,S=n.length;p<S;p++)if(s===Pe(this._moveToSan(n[p],n)))return n[p];if(t)return null;let a,o,d,g,v,E=!1;if(o=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),o?(a=o[1],d=o[2],g=o[3],v=o[4],d.length==1&&(E=!0)):(o=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),o&&(a=o[1],d=o[2],g=o[3],v=o[4],d.length==1&&(E=!0))),r=gt(s),n=this._moves({legal:!0,piece:a||r}),!g)return null;for(let p=0,S=n.length;p<S;p++)if(d){if((!a||a.toLowerCase()==n[p].piece)&&x[d]==n[p].from&&x[g]==n[p].to&&(!v||v.toLowerCase()==n[p].promotion))return n[p];if(E){const T=L(n[p].from);if((!a||a.toLowerCase()==n[p].piece)&&x[g]==n[p].to&&(d==T[0]||d==T[1])&&(!v||v.toLowerCase()==n[p].promotion))return n[p]}}else if(s===Pe(this._moveToSan(n[p],n)).replace("x",""))return n[p];return null}ascii(){let e=`   +------------------------+
`;for(let t=x.a8;t<=x.h1;t++){if(ue(t)===0&&(e+=" "+"87654321"[te(t)]+" |"),this._board[t]){const s=this._board[t].type,n=this._board[t].color===F?s.toUpperCase():s.toLowerCase();e+=" "+n+" "}else e+=" . ";t+1&136&&(e+=`|
`,t+=8)}return e+=`   +------------------------+
`,e+="     a  b  c  d  e  f  g  h",e}perft(e){const t=this._moves({legal:!1});let s=0;const r=this._turn;for(let n=0,a=t.length;n<a;n++)this._makeMove(t[n]),this._isKingAttacked(r)||(e-1>0?s+=this.perft(e-1):s++),this._undoMove();return s}setTurn(e){return this._turn==e?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const e=[];let t=[];for(let s=x.a8;s<=x.h1;s++)this._board[s]==null?t.push(null):t.push({square:L(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(e.push(t),t=[],s+=8);return e}squareColor(e){if(e in x){const t=x[e];return(te(t)+ue(t))%2===0?"light":"dark"}return null}history({verbose:e=!1}={}){const t=[],s=[];for(;this._history.length>0;)t.push(this._undoMove());for(;;){const r=t.pop();if(!r)break;e?s.push(new ve(this,r)):s.push(this._moveToSan(r,this._moves())),this._makeMove(r)}return s}_getPositionCount(e){return this._positionCount.get(e)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(e){const t=this._positionCount.get(e)??0;t===1?this._positionCount.delete(e):this._positionCount.set(e,t-1)}_pruneComments(){const e=[],t={},s=r=>{r in this._comments&&(t[r]=this._comments[r])};for(;this._history.length>0;)e.push(this._undoMove());for(s(this.fen());;){const r=e.pop();if(!r)break;this._makeMove(r),s(this.fen())}this._comments=t}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>({fen:e,comment:this._comments[e]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>{const t=this._comments[e];return delete this._comments[e],{fen:e,comment:t}})}setCastlingRights(e,t){for(const r of[P,Y])t[r]!==void 0&&(t[r]?this._castling[e]|=_e[r]:this._castling[e]&=~_e[r]);this._updateCastlingRights();const s=this.getCastlingRights(e);return(t[P]===void 0||t[P]===s[P])&&(t[Y]===void 0||t[Y]===s[Y])}getCastlingRights(e){return{[P]:(this._castling[e]&_e[P])!==0,[Y]:(this._castling[e]&_e[Y])!==0}}moveNumber(){return this._moveNumber}}const I={AUTH:"auth",AUTHED:"authed",CREATE:"my_room",JOIN:"join",LEAVE:"leave",LEFT:"left",MOVE:"move",RESTART:"restart_game",GAME_RESTARTED:"game_restarted",GAME_STARTED:"game_started",KICK_MEMBER:"kick_member",MEMBER_JOINED:"member_joined",MEMBER_LEFT:"member_left",MEMBER_KICKED:"member_kicked",ROOM_STATE:"room_state",CREATED:"created",JOINED:"joined",ERROR:"error",ROOM_CLOSED:"room_closed"};class ao{client;constructor(){this.client=new Rs("/chess")}on(e,t){this.client.on(e,t)}connect(){this.client.connect()}send(e){this.client.send(e)}close(){this.client.close()}get connected(){return this.client.connected}}const ie={wK:"♔",wQ:"♕",wR:"♖",wB:"♗",wN:"♘",wP:"♙",bK:"♚",bQ:"♛",bR:"♜",bB:"♝",bN:"♞",bP:"♟"},be=["a","b","c","d","e","f","g","h"],lo=[8,7,6,5,4,3,2,1];function co(i){return typeof i?.isCheckmate=="function"?i.isCheckmate():typeof i?.in_checkmate=="function"?i.in_checkmate():!1}function ho(i){return typeof i?.isStalemate=="function"?i.isStalemate():typeof i?.in_stalemate=="function"?i.in_stalemate():!1}function fo(i){return typeof i?.isDraw=="function"?i.isDraw():typeof i?.in_draw=="function"?i.in_draw():!1}function uo(i){return typeof i?.isThreefoldRepetition=="function"?i.isThreefoldRepetition():typeof i?.in_threefold_repetition=="function"?i.in_threefold_repetition():!1}function mo(i){return typeof i?.isCheck=="function"?i.isCheck():typeof i?.in_check=="function"?i.in_check():!1}function vt(i){return{memberId:String(i?.memberId||i?.member_id||""),userId:String(i?.userId||i?.user_id||""),username:String(i?.username||"玩家"),role:i?.role==="black"?"black":"white",isOwner:!!(i?.isOwner||i?.is_owner),joinedAt:Number(i?.joinedAt||i?.joined_at||0)||void 0}}function _t(){return new Ke}function po(i){return i==="error"?"error":"info"}const go=xs("chess",{state:()=>({loading:!0,myUserId:"",myUsername:"",myUserNumber:"",authToken:"",service:null,connecting:!1,connected:!1,currentRoom:null,roomId:"",roomCode:"",isOwner:!1,ownerUserId:"",members:[],channelTitle:"",pendingJoinTarget:null,skipNextRoomClosedToast:!1,pendingMoveIds:[],chess:_t(),myRole:null,selectedSquare:"",legalMoves:[],moveHistory:[],lastMove:null,gameStarted:!1,gameResult:"",gameStartTime:"",boardResetting:!1,boardRenderTick:0,showPromotion:!1,promotionFrom:"",promotionTo:"",joinCode:"",drawerJoinCode:"",entryError:"",showChannelDrawer:typeof window<"u"?window.innerWidth>=768:!0,showOwnerMenu:!1,showMembersModal:!1,showRestartConfirm:!1,showKickConfirm:!1,kickTarget:null,restartCountdown:0,restartTimer:null,showSwitchJoinConfirm:!1,switchJoinDecision:null,toast:null,toastExiting:!1,toastTimer:null,pageshowHandler:null}),getters:{inRoom:i=>!!(i.currentRoom&&i.roomId),viewMode(){return this.loading?"loading":this.inRoom?"room":"entry"},isMyTurn(){if(!this.chess||!this.myRole||!this.gameStarted)return!1;const i=this.chess.turn();return i==="w"&&this.myRole==="white"||i==="b"&&this.myRole==="black"},waitingForOpponent:i=>i.members.length<2,orientation(){return this.myRole==="black"?"black":"white"},boardRows(){const i=this;i.boardRenderTick;const e=i.orientation==="black"?[1,2,3,4,5,6,7,8]:[8,7,6,5,4,3,2,1],t=i.orientation==="black"?["h","g","f","e","d","c","b","a"]:be;return e.map(s=>({label:s,squares:t.map(r=>{const n=`${r}${s}`,a=i.chess?i.chess.get(n):null,o=(be.indexOf(r)+s)%2===1;return{name:n,piece:a,isLight:o,isSelected:i.selectedSquare===n,isLegal:i.legalMoves.includes(n),isLastFrom:i.lastMove?.from===n,isLastTo:i.lastMove?.to===n,isCheck:i.isCheckSquare(n)}})}))},fileLabels(){return this.orientation==="black"?["h","g","f","e","d","c","b","a"]:be},sortedPlayers:i=>[...i.members].sort((e,t)=>e.role===t.role?0:e.role==="white"?-1:1),promotionPieces(){const i=this.myRole==="white"?"w":"b";return[{type:"q",name:"后",unicode:ie[`${i}Q`]},{type:"r",name:"车",unicode:ie[`${i}R`]},{type:"b",name:"象",unicode:ie[`${i}B`]},{type:"n",name:"马",unicode:ie[`${i}N`]}]},switchJoinPrompt(i){return i.switchJoinDecision?.prompt||""}},actions:{defer(i){Promise.resolve().then(i)},isWsReady(){return!!this.service?.connected},bumpBoardRender(){this.boardRenderTick+=1},safeLoadFen(i){if(!i)return!1;try{return this.chess.load(i),!0}catch{return!1}},resetTransientUi(){this.showOwnerMenu=!1,this.showMembersModal=!1,this.showRestartConfirm=!1,this.showKickConfirm=!1,this.kickTarget=null,this.showPromotion=!1,this.promotionFrom="",this.promotionTo="",this.showSwitchJoinConfirm=!1,this.switchJoinDecision=null,this.restartCountdown=0,this.restartTimer&&(window.clearInterval(this.restartTimer),this.restartTimer=null)},resetGameState(){this.chess.reset(),this.members=[],this.moveHistory=[],this.lastMove=null,this.selectedSquare="",this.legalMoves=[],this.gameStarted=!1,this.gameResult="",this.gameStartTime="",this.roomId="",this.roomCode="",this.channelTitle="",this.myRole=null,this.isOwner=!1,this.ownerUserId="",this.pendingMoveIds=[],this.resetTransientUi(),this.bumpBoardRender()},showToast(i,e="info"){this.toastTimer&&window.clearTimeout(this.toastTimer),this.toastExiting=!1,this.toast={message:i,type:e},this.toastTimer=window.setTimeout(()=>{this.toastExiting=!0,window.setTimeout(()=>{this.toast=null},200)},2500)},async init(){this.resetTransientUi(),this.loading=!0,this.chess=_t(),this.pageshowHandler&&window.removeEventListener("pageshow",this.pageshowHandler),this.pageshowHandler=()=>{this.resetTransientUi()},window.addEventListener("pageshow",this.pageshowHandler);const i=ft();if(!await i.restoreSession()||!i.user||!i.token){window.location.href="/applications/auth";return}this.myUserId=String(i.user.id||""),this.myUsername=String(i.user.username||""),this.myUserNumber=i.user.userNumber?String(i.user.userNumber):"",this.authToken=String(i.token||""),this.loading=!1,this.setupWebSocket();const t=$s();t==="my_room"?window.setTimeout(()=>this.connectMyRoom(),100):/^\d{4,18}$/.test(String(t||""))&&(this.joinCode=String(t||""),window.setTimeout(()=>this.joinRoom(),120))},setupWebSocket(){if(this.service)return;const i=ft();this.service=new ao,this.service.on("_open",()=>{this.service?.send({type:I.AUTH,token:this.authToken})}),this.service.on(I.AUTHED,()=>{this.connected=!0});const e=t=>this.handleRoomEntered(t);this.service.on(I.CREATED,e),this.service.on(I.JOINED,e),this.service.on(I.ROOM_STATE,e),this.service.on(I.GAME_STARTED,t=>{this.gameStarted=!0,this.gameStartTime=t?.startedAt?X(t.startedAt):X(Date.now()),this.showToast("对局开始！")}),this.service.on(I.MOVE,t=>{this.applyIncomingMove(t)}),this.service.on(I.GAME_RESTARTED,t=>{this.boardResetting=!0,window.setTimeout(()=>{this.chess.reset();const s=String(t?.state?.fen||"");s&&s!=="start"&&this.safeLoadFen(s),this.moveHistory=[],this.lastMove=null,this.selectedSquare="",this.legalMoves=[],this.showPromotion=!1,this.promotionFrom="",this.promotionTo="",this.gameResult="",this.gameStarted=this.members.length>=2,this.gameStartTime=t?.startedAt?X(t.startedAt):X(Date.now()),this.showRestartConfirm=!1,this.boardResetting=!1,this.bumpBoardRender(),this.showToast("棋局已重启")},200)}),this.service.on(I.MEMBER_JOINED,t=>{const s=vt(t?.member||{});s.memberId&&(this.members.some(r=>r.memberId===s.memberId)||(this.members=[...this.members,s]),this.members.length>=2&&(this.gameStarted=!0),this.showToast(`${s.username} 加入了对局`))}),this.service.on(I.MEMBER_LEFT,t=>{const s=String(t?.memberId||t?.member_id||""),r=this.members.find(n=>n.memberId===s);this.members=this.members.filter(n=>n.memberId!==s),r&&this.showToast(`${r.username} 离开了对局`)}),this.service.on(I.MEMBER_KICKED,t=>{const s=String(t?.memberId||t?.member_id||""),r=this.members.find(n=>n.memberId===s);this.members=this.members.filter(n=>n.memberId!==s),String(t?.userId||t?.user_id||"")===this.myUserId?this.handleRoomExited({toast:"你已被移出对局",toastType:"error"}):r&&this.showToast(`${r.username} 已被移除`)}),this.service.on(I.ROOM_CLOSED,()=>{const t=this.skipNextRoomClosedToast?"":"对局已关闭",s=this.skipNextRoomClosedToast?"info":"error";this.skipNextRoomClosedToast=!1,this.handleRoomExited({toast:t,toastType:s})}),this.service.on(I.LEFT,()=>{this.handleRoomExited()}),this.service.on(I.ERROR,async t=>{if(t?.code==="auth_failed"){const s=await i.refreshSession();if(s&&s.token){this.authToken=String(s.token),this.service?.send({type:I.AUTH,token:this.authToken});return}await i.logout(),window.location.href="/applications/auth";return}this.showToast(t?.message||"操作失败","error"),this.connecting=!1}),this.service.on("_close",()=>{this.connected=!1,this.inRoom&&this.showToast("连接中断，正在重连…","error")}),this.service.connect()},handleRoomEntered(i){const e=String(i?.roomId||i?.room_id||"").trim();if(!e){this.handleRoomExited({toast:"棋局状态异常，请重新加入",toastType:"error"});return}this.currentRoom=i,this.roomId=e,this.roomCode=String(i?.code||""),this.isOwner=!!(i?.isOwner||i?.is_owner),this.ownerUserId=String(i?.ownerUserId||i?.owner_user_id||""),this.members=Array.isArray(i?.members)?i.members.map(s=>vt(s)):[],this.myRole=i?.role==="black"?"black":"white",this.channelTitle=this.isOwner?"我的频道":this.roomCode||"频道",this.connecting=!1,this.entryError="",this.resetTransientUi(),this.skipNextRoomClosedToast=!1,this.pendingMoveIds=[],this.chess.reset();const t=String(i?.state?.fen||"");t&&t!=="start"&&this.safeLoadFen(t),this.moveHistory=[],this.lastMove=null,this.selectedSquare="",this.legalMoves=[],this.showPromotion=!1,this.promotionFrom="",this.promotionTo="",this.gameResult="",this.gameStarted=this.members.length>=2,this.gameStartTime=i?.startedAt?X(i.startedAt):i?.createdAt?X(i.createdAt):"",this.bumpBoardRender(),this.checkGameEnd(),ut(this.isOwner?"my_room":this.roomCode)},handleRoomExited(i={}){this.currentRoom=null,this.connecting=!1,this.showOwnerMenu=!1,this.resetGameState(),ut(""),i.toast&&this.showToast(i.toast,po(i.toastType)),this.defer(()=>this.consumePendingJoin())},consumePendingJoin(){const i=this.pendingJoinTarget;if(i){if(this.pendingJoinTarget=null,i.type==="my_room"){this.connectMyRoom();return}i.type==="join_code"&&i.code&&(this.joinCode=i.code,this.joinRoom({bypassCurrentRoomCheck:!0}))}},connectMyRoom(){if(this.inRoom&&this.isOwner){this.showToast("你已经在自己的棋局");return}if(this.inRoom&&!this.isOwner){this.switchJoinDecision={action:"leave_then_join",target:"my_room",prompt:"你当前在其他棋局中。要先退出当前棋局，再进入你的棋局吗？"},this.showSwitchJoinConfirm=!0;return}if(!this.connected){this.service?.connect(),window.setTimeout(()=>this.connectMyRoom(),500);return}this.pendingJoinTarget=null,this.connecting=!0,this.entryError="",this.service?.send({type:I.CREATE})},joinRoom(i={}){const e=!!i.bypassCurrentRoomCheck,t=String(this.joinCode||"").trim();if(t){if(!/^\d{4,18}$/.test(t)){this.entryError="请输入 4-18 位数字号码";return}if(!e){const s=Is({currentRoom:this.currentRoom,isOwner:this.isOwner,currentCode:this.roomCode,targetCode:t,roomLabel:"棋局"});if(s.action==="already_in_target"){this.entryError="",this.showToast("你已经在这个棋局");return}if(s.action==="close_then_join"||s.action==="leave_then_join"){this.switchJoinDecision={action:s.action,target:"join_code",code:t,prompt:s.prompt},this.showSwitchJoinConfirm=!0;return}}if(!this.connected){this.service?.connect(),window.setTimeout(()=>this.joinRoom({bypassCurrentRoomCheck:!0}),500);return}this.pendingJoinTarget=null,this.connecting=!0,this.entryError="",this.service?.send({type:I.JOIN,code:t})}},joinRoomFromDrawer(){this.joinCode=String(this.drawerJoinCode||"").trim(),this.drawerJoinCode="",this.showChannelDrawer=!1,this.joinRoom()},confirmSwitchJoin(){const i=this.switchJoinDecision;if(!i){this.showSwitchJoinConfirm=!1;return}this.showSwitchJoinConfirm=!1,this.switchJoinDecision=null,i.target==="my_room"?this.pendingJoinTarget={type:"my_room"}:this.pendingJoinTarget={type:"join_code",code:String(i.code||"")},i.action==="close_then_join"?this.closeRoom("switch_join"):this.leaveRoom()},cancelSwitchJoin(){this.showSwitchJoinConfirm=!1,this.switchJoinDecision=null,this.pendingJoinTarget=null},leaveRoom(){this.inRoom&&(this.showOwnerMenu=!1,this.service?.send({type:I.LEAVE}))},closeRoom(i="owner_close"){!this.inRoom||!this.isOwner||(this.showOwnerMenu=!1,i==="switch_join"&&(this.skipNextRoomClosedToast=!0),this.service?.send({type:"close_room",reason:i}))},onSquareClick(i){if(!this.gameStarted||this.gameResult)return;if(!this.isMyTurn){this.flashIllegal(i.name);return}const e=this.myRole==="white"?"w":"b";if(this.selectedSquare){if(i.name===this.selectedSquare){this.selectedSquare="",this.legalMoves=[];return}if(this.legalMoves.includes(i.name)){this.tryMove(this.selectedSquare,i.name);return}if(i.piece&&i.piece.color===e){this.selectSquare(i.name);return}this.flashIllegal(i.name),this.selectedSquare="",this.legalMoves=[];return}i.piece&&i.piece.color===e&&this.selectSquare(i.name)},selectSquare(i){this.chess&&(this.selectedSquare=i,this.legalMoves=this.chess.moves({square:i,verbose:!0}).map(e=>e.to))},tryMove(i,e){const t=this.chess.get(i);if(t&&t.type==="p"){const s=e[1];if(t.color==="w"&&s==="8"||t.color==="b"&&s==="1"){this.promotionFrom=i,this.promotionTo=e,this.showPromotion=!0;return}}this.executeMove(i,e)},doPromotion(i){if(!this.promotionFrom||!this.promotionTo){this.showPromotion=!1;return}this.showPromotion=!1,this.executeMove(this.promotionFrom,this.promotionTo,i),this.promotionFrom="",this.promotionTo=""},executeMove(i,e,t){if(!this.chess)return;if(!this.isWsReady()){this.service?.connect(),this.showToast("连接中，请稍后再试","error");return}const s={from:i,to:e};t&&(s.promotion=t);const r=new Ke(this.chess.fen()),n=r.move(s);if(!n){this.flashIllegal(e),this.selectedSquare="",this.legalMoves=[];return}this.selectedSquare="",this.legalMoves=[],this.showPromotion=!1,this.promotionFrom="",this.promotionTo="",this.chess.load(r.fen());const a={from:String(n.from),to:String(n.to),san:String(n.san||`${n.from}-${n.to}`)};this.moveHistory=[...this.moveHistory,a],this.lastMove={from:a.from,to:a.to},this.checkGameEnd(),this.bumpBoardRender();const o=`${Date.now()}-${Math.random().toString(36).slice(2,8)}`;this.pendingMoveIds=[...this.pendingMoveIds,o].slice(-40),this.service?.send({type:I.MOVE,move:{from:a.from,to:a.to,promotion:n.promotion||void 0,san:n.san||"",clientMoveId:o},state:{fen:r.fen()}})},applyIncomingMove(i){if(!this.chess||!i?.move)return;const e=String(i?.move?.clientMoveId||"");if(e&&this.pendingMoveIds.includes(e)){this.pendingMoveIds=this.pendingMoveIds.filter(a=>a!==e);return}const t=String(i?.move?.from||""),s=String(i?.move?.to||""),r=i?.move?.promotion||void 0;if(!t||!s||!e&&i?.state?.fen&&typeof i.state.fen=="string"&&i.state.fen===this.chess.fen()&&this.lastMove?.from===t&&this.lastMove?.to===s)return;let n=!1;if(i?.state?.fen&&typeof i.state.fen=="string"&&(n=this.safeLoadFen(i.state.fen)),!n){const a=new Ke(this.chess.fen());if(!a.move({from:t,to:s,promotion:r}))return;this.chess.load(a.fen())}this.moveHistory=[...this.moveHistory,{from:t,to:s,san:String(i?.move?.san||`${t}-${s}`)}],this.lastMove={from:t,to:s},this.selectedSquare="",this.legalMoves=[],this.showPromotion=!1,this.promotionFrom="",this.promotionTo="",this.checkGameEnd(),this.bumpBoardRender()},flashIllegal(i){const e=document.querySelector(`[data-sq="${i}"]`);e&&(e.classList.add("chess-square-illegal"),window.setTimeout(()=>{e.classList.remove("chess-square-illegal")},400))},checkGameEnd(){if(this.chess)if(co(this.chess)){const i=this.chess.turn();i==="w"&&this.myRole==="white"||i==="b"&&this.myRole==="black"?this.gameResult="将杀！你输了":this.gameResult="将杀！你赢了！"}else ho(this.chess)?this.gameResult="和棋 — 逼和":fo(this.chess)?this.gameResult="和棋":uo(this.chess)?this.gameResult="和棋 — 三次重复":this.gameResult=""},isCheckSquare(i){if(!this.chess||!mo(this.chess))return!1;const e=this.chess.turn(),t=this.chess.get(i);return!!(t&&t.type==="k"&&t.color===e)},isCurrentTurn(i){if(!this.chess||!this.gameStarted)return!1;const e=this.chess.turn();return e==="w"&&i.role==="white"||e==="b"&&i.role==="black"},getCapturedPieces(i){const e={p:8,n:2,b:2,r:2,q:1},t={p:0,n:0,b:0,r:0,q:0};for(const a of be)for(const o of lo){const d=this.chess.get(`${a}${o}`);d&&d.color===i&&t[d.type]!=null&&(t[d.type]+=1)}const s=[],r=i==="w"?"b":"w",n={p:"P",n:"N",b:"B",r:"R",q:"Q"};for(const[a,o]of Object.entries(e))for(let d=0;d<o-t[a];d+=1)s.push(ie[`${r}${n[a]}`]);return s},pieceUnicode(i){if(!i)return"";const e=i.color==="w"?"w":"b";return ie[`${e}${String(i.type||"").toUpperCase()}`]||""},squareClasses(i){const e=[i.isLight?"chess-square-light":"chess-square-dark"];return i.isSelected&&e.push("chess-square-selected"),i.isLegal&&i.piece&&e.push("chess-sq-capture"),i.isCheck&&e.push("chess-sq-check"),i.isLastFrom&&e.push("chess-sq-last-from"),i.isLastTo&&e.push("chess-sq-last-to"),e},confirmRestart(){this.showOwnerMenu=!1,this.showRestartConfirm=!0,this.restartCountdown=3,this.restartTimer&&window.clearInterval(this.restartTimer),this.restartTimer=window.setInterval(()=>{this.restartCountdown-=1,this.restartCountdown<=0&&this.restartTimer&&(window.clearInterval(this.restartTimer),this.restartTimer=null)},1e3)},dismissRestart(){this.showRestartConfirm=!1,this.restartCountdown=0,this.restartTimer&&(window.clearInterval(this.restartTimer),this.restartTimer=null)},executeRestart(){this.restartCountdown>0||(this.service?.send({type:I.RESTART}),this.dismissRestart())},confirmKickMember(i){!this.inRoom||!this.isOwner||!i?.memberId||i.isOwner||(this.kickTarget=i,this.showKickConfirm=!0,this.showMembersModal=!1)},dismissKickConfirm(){this.showKickConfirm=!1,this.kickTarget=null},executeKick(){if(!this.inRoom||!this.isOwner||!this.kickTarget?.memberId){this.dismissKickConfirm();return}this.service?.send({type:I.KICK_MEMBER,memberId:this.kickTarget.memberId}),this.dismissKickConfirm()},async showInviteInfo(){if(this.roomCode)try{await navigator.clipboard.writeText(this.roomCode),this.showToast(`号码 ${this.roomCode} 已复制，分享给对手即可加入`)}catch{this.showToast(`你的号码：${this.roomCode}，分享给对手即可加入`)}},formatTime:X,getInitial:As,getAvatarColor:Ms,destroy(){this.pageshowHandler&&(window.removeEventListener("pageshow",this.pageshowHandler),this.pageshowHandler=null),this.service&&(this.service.close(),this.service=null),this.connected=!1,this.connecting=!1,this.loading=!1,this.restartTimer&&(window.clearInterval(this.restartTimer),this.restartTimer=null),this.toastTimer&&(window.clearTimeout(this.toastTimer),this.toastTimer=null)}}}),vo=ae({__name:"ChessPage",setup(i,{expose:e}){e();const t=go();function s(){t.showOwnerMenu=!1,t.showMembersModal=!0}Es(async()=>{await t.init()}),Ts(()=>{t.destroy()});const r={chessStore:t,openMembersPanel:s,ChessTopBar:Qs,ChessBoard:ri,ChessPlayersPanel:_i,ChessMoveHistory:Ci,ChessDrawer:Ki,ConfirmModal:Os,ToastHost:Ps};return Object.defineProperty(r,"__isScriptSetup",{enumerable:!1,value:!0}),r}}),_o={class:"h-screen bg-surface-0 font-sans relative noise-overlay grid-pattern flex flex-col overflow-hidden"},bo={class:"flex-1 flex overflow-hidden"},wo={class:"flex-1 flex flex-col min-w-0 overflow-y-auto"},yo={key:0,class:"flex-1 flex items-center justify-center"},ko={key:1,class:"flex-1 flex flex-col items-center justify-center px-6 animate-fade-in-up"},So={class:"w-16 h-16 rounded-2xl flex items-center justify-center mb-6",style:{background:"var(--surface-2)"}},xo={class:"flex flex-col sm:flex-row gap-3 w-full max-w-sm"},Co=["disabled"],Eo={class:"mt-4 w-full max-w-sm"},To={class:"flex gap-2"},Ro=["disabled"],Mo={key:0,class:"mt-3 text-xs",style:{color:"var(--danger)"}},Ao={key:2,class:"flex-1 flex flex-col"},Io={class:"shrink-0 px-4 md:px-8 pt-4 md:pt-6"},$o={class:"flex items-center justify-between mb-4"},Oo={class:"flex items-center gap-2 min-w-0"},Po={class:"text-sm font-semibold",style:{color:"var(--ink-0)"}},No={class:"text-xs px-2 py-0.5 rounded-full",style:{background:"var(--surface-2)",color:"var(--ink-2)"}},Lo={class:"flex items-center gap-2"},Ko={key:0,class:"flex items-center justify-center gap-3 mx-4 md:mx-8 mb-4 px-4 py-3 rounded-lg",style:{background:"var(--surface-2)"}},Do={key:1,class:"flex items-center justify-center gap-3 mx-4 md:mx-8 mb-4 px-4 py-3 rounded-lg",style:{background:"var(--surface-2)"}},Fo={class:"flex-1 flex items-start justify-center px-4 md:px-8 pb-4"},qo={key:0,class:"fixed inset-0 z-[70] flex items-center justify-center p-4",role:"dialog","aria-label":"成员管理"},jo={class:"relative w-full max-w-md rounded-2xl border p-4 md:p-5 modal-content",style:{background:"var(--surface-1)","border-color":"var(--ink-4)","box-shadow":"var(--shadow-modal)"}},Uo={class:"flex items-center justify-between mb-3"},Bo={class:"max-h-[55vh] overflow-y-auto"},Ho={class:"min-w-0"},Jo={class:"text-sm font-medium truncate",style:{color:"var(--ink-0)"}},Qo={key:0,class:"text-xs ml-1",style:{color:"var(--ink-3)"}},Go={class:"text-xs",style:{color:"var(--ink-3)"}},Vo=["onClick"],Wo={key:1,class:"fixed inset-0 z-[85] flex items-center justify-center p-4",role:"dialog","aria-label":"升变选择"},zo={class:"relative w-full max-w-sm rounded-2xl border p-5 text-center modal-content",style:{background:"var(--surface-1)","border-color":"var(--ink-4)","box-shadow":"var(--shadow-modal)"}},Yo={class:"grid grid-cols-4 gap-2 mt-4"},Zo=["onClick"],Xo={class:"text-2xl"},er={class:"text-xs mt-1",style:{color:"var(--ink-2)"}};function tr(i,e,t,s,r,n){const a=De("iconify-icon");return y(),k("div",_o,[M(s.ChessTopBar,{"in-room":s.chessStore.inRoom,"is-owner":s.chessStore.isOwner,"show-owner-menu":s.chessStore.showOwnerMenu,"show-channel-drawer":s.chessStore.showChannelDrawer,onToggleOwnerMenu:e[0]||(e[0]=o=>s.chessStore.showOwnerMenu=!s.chessStore.showOwnerMenu),onToggleDrawer:e[1]||(e[1]=o=>s.chessStore.showChannelDrawer=!s.chessStore.showChannelDrawer),onOpenMembers:s.openMembersPanel,onInvite:e[2]||(e[2]=o=>s.chessStore.showInviteInfo()),onRestart:e[3]||(e[3]=o=>s.chessStore.confirmRestart()),onCloseRoomMenu:e[4]||(e[4]=o=>s.chessStore.closeRoom("owner_close_from_menu"))},null,8,["in-room","is-owner","show-owner-menu","show-channel-drawer"]),u("div",bo,[u("div",wo,[s.chessStore.viewMode==="loading"?(y(),k("div",yo,[...e[28]||(e[28]=[u("div",{class:"w-8 h-8 border-2 rounded-full",style:{"border-color":"var(--ink-4)","border-top-color":"var(--ink-0)",animation:"spin 0.8s linear infinite"}},null,-1)])])):s.chessStore.viewMode==="entry"?(y(),k("div",ko,[u("div",So,[M(a,{icon:"lucide:crown",class:"text-2xl",style:{color:"var(--ink-3)"}})]),e[30]||(e[30]=u("h2",{class:"text-xl font-semibold mb-2",style:{color:"var(--ink-0)","font-family":"var(--font-heading)"}},"Chess 对局",-1)),e[31]||(e[31]=u("p",{class:"text-sm mb-8 text-center max-w-xs",style:{color:"var(--ink-2)"}},"开始你的棋局，或输入用户号码加入他人的对局",-1)),u("div",xo,[u("button",{class:"flex-1 flex items-center justify-center gap-2 px-5 py-3 rounded-xl text-sm font-semibold transition-all",style:{background:"var(--ink-0)",color:"white"},disabled:s.chessStore.connecting,onClick:e[5]||(e[5]=o=>s.chessStore.connectMyRoom())},[M(a,{icon:"lucide:swords",class:"text-base"}),e[29]||(e[29]=G(" 我的棋局 ",-1))],8,Co)]),u("div",Eo,[u("div",To,[Cs(u("input",{"onUpdate:modelValue":e[6]||(e[6]=o=>s.chessStore.joinCode=o),type:"text",inputmode:"numeric",maxlength:"18",class:"fh-input flex-1 px-4 py-2.5 rounded-xl border text-sm outline-none transition-all",placeholder:"输入用户号码加入对局",style:{background:"var(--surface-1)","border-color":"var(--ink-4)",color:"var(--ink-0)"},onKeydown:e[7]||(e[7]=bt(o=>s.chessStore.joinRoom(),["enter"]))},null,544),[[Ss,s.chessStore.joinCode]]),u("button",{class:"px-5 py-2.5 rounded-xl text-sm font-semibold transition-all border",style:{"border-color":"var(--ink-4)",color:"var(--ink-1)"},disabled:s.chessStore.connecting||!s.chessStore.joinCode,onClick:e[8]||(e[8]=o=>s.chessStore.joinRoom())}," 加入 ",8,Ro)])]),s.chessStore.entryError?(y(),k("p",Mo,$(s.chessStore.entryError),1)):K("",!0)])):(y(),k("div",Ao,[u("div",Io,[u("div",$o,[u("div",Oo,[M(a,{icon:"lucide:hash",class:"text-sm",style:{color:"var(--ink-3)"}}),u("span",Po,$(s.chessStore.channelTitle),1),u("span",No,$(s.chessStore.members.length)+" 位玩家 ",1)]),u("div",Lo,[s.chessStore.isOwner&&s.chessStore.gameStarted?(y(),k("button",{key:0,class:"hidden md:flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--ink-2)"},onClick:e[9]||(e[9]=o=>s.chessStore.confirmRestart())},[M(a,{icon:"lucide:rotate-ccw",class:"text-sm"}),e[32]||(e[32]=G(" 重启棋局 ",-1))])):K("",!0),s.chessStore.isOwner?(y(),k("button",{key:1,class:"px-2 py-1 rounded-lg text-xs font-medium transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--danger)"},onClick:e[10]||(e[10]=o=>s.chessStore.closeRoom("owner_close_from_header"))}," 关闭棋局 ")):(y(),k("button",{key:2,class:"px-2 py-1 rounded-lg text-xs font-medium transition-colors hover:bg-[var(--surface-2)]",style:{color:"var(--ink-2)"},onClick:e[11]||(e[11]=o=>s.chessStore.leaveRoom())}," 离开 "))])]),M(s.ChessPlayersPanel,{players:s.chessStore.sortedPlayers,"my-user-id":s.chessStore.myUserId,"is-current-turn":s.chessStore.isCurrentTurn,"get-initial":s.chessStore.getInitial,"get-avatar-color":s.chessStore.getAvatarColor,"get-captured-pieces":s.chessStore.getCapturedPieces},null,8,["players","my-user-id","is-current-turn","get-initial","get-avatar-color","get-captured-pieces"])]),s.chessStore.gameStarted?(y(),k("div",Ko,[s.chessStore.isMyTurn?(y(),k(U,{key:0},[e[33]||(e[33]=u("div",{class:"w-3 h-3 rounded-full animate-pulse status-dot-green",style:{background:"var(--state-green)"}},null,-1)),e[34]||(e[34]=u("span",{class:"text-sm font-semibold",style:{color:"var(--ink-0)"}},"轮到你走棋",-1))],64)):s.chessStore.waitingForOpponent?(y(),k(U,{key:1},[e[35]||(e[35]=u("div",{class:"w-3 h-3 rounded-full",style:{background:"var(--ink-3)"}},null,-1)),e[36]||(e[36]=u("span",{class:"text-sm font-medium",style:{color:"var(--ink-2)"}},"等待对手加入…",-1))],64)):(y(),k(U,{key:2},[e[37]||(e[37]=u("div",{class:"w-3 h-3 rounded-full status-dot-yellow",style:{background:"var(--state-yellow)"}},null,-1)),e[38]||(e[38]=u("span",{class:"text-sm font-medium",style:{color:"var(--ink-1)"}},"等待对手走棋",-1))],64)),s.chessStore.gameResult?(y(),k("span",{key:3,class:"text-sm font-semibold ml-2",style:fe(s.chessStore.gameResult.includes("赢")?"color: var(--state-green)":"color: var(--danger)")},$(s.chessStore.gameResult),5)):K("",!0)])):K("",!0),s.chessStore.inRoom&&!s.chessStore.gameStarted&&s.chessStore.members.length<2?(y(),k("div",Do,[e[39]||(e[39]=u("div",{class:"w-3 h-3 rounded-full",style:{background:"var(--state-yellow)",animation:"subtlePulse 2s ease-in-out infinite"}},null,-1)),e[40]||(e[40]=u("span",{class:"text-sm font-medium",style:{color:"var(--ink-1)"}},"等待第二位玩家加入…",-1)),s.chessStore.isOwner?(y(),k("button",{key:0,class:"text-xs px-2 py-1 rounded-lg border transition-colors hover:bg-[var(--surface-3)]",style:{"border-color":"var(--ink-4)",color:"var(--ink-2)"},onClick:e[12]||(e[12]=o=>s.chessStore.showInviteInfo())}," 分享号码 ")):K("",!0)])):K("",!0),u("div",Fo,[u("div",{class:oe(["w-full max-w-md md:max-w-lg",{"board-reset-flash":s.chessStore.boardResetting}])},[M(s.ChessBoard,{"board-rows":s.chessStore.boardRows,"file-labels":s.chessStore.fileLabels,"piece-unicode":s.chessStore.pieceUnicode,"square-classes":s.chessStore.squareClasses,onSquareClick:s.chessStore.onSquareClick},null,8,["board-rows","file-labels","piece-unicode","square-classes","onSquareClick"]),M(s.ChessMoveHistory,{moves:s.chessStore.moveHistory},null,8,["moves"])],2)])]))]),M(s.ChessDrawer,{show:s.chessStore.showChannelDrawer,"in-room":s.chessStore.inRoom,"is-owner":s.chessStore.isOwner,"room-code":s.chessStore.roomCode,"join-code":s.chessStore.drawerJoinCode,onClose:e[13]||(e[13]=o=>s.chessStore.showChannelDrawer=!1),onConnectMyRoom:e[14]||(e[14]=o=>s.chessStore.connectMyRoom()),onJoinCode:e[15]||(e[15]=o=>s.chessStore.joinRoomFromDrawer()),"onUpdate:joinCode":e[16]||(e[16]=o=>s.chessStore.drawerJoinCode=o),onLeaveRoom:e[17]||(e[17]=o=>s.chessStore.leaveRoom()),onCloseRoom:e[18]||(e[18]=o=>s.chessStore.closeRoom("owner_close_from_drawer"))},null,8,["show","in-room","is-owner","room-code","join-code"])]),s.chessStore.showMembersModal?(y(),k("div",qo,[u("div",{class:"absolute inset-0 bg-black/30",onClick:e[19]||(e[19]=o=>s.chessStore.showMembersModal=!1)}),u("div",jo,[u("div",Uo,[e[41]||(e[41]=u("h3",{class:"text-lg font-semibold",style:{color:"var(--ink-0)","font-family":"var(--font-heading)"}},"对局成员",-1)),u("button",{class:"p-1",style:{color:"var(--ink-2)"},onClick:e[20]||(e[20]=o=>s.chessStore.showMembersModal=!1)},[M(a,{icon:"lucide:x",class:"text-base"})])]),u("div",Bo,[(y(!0),k(U,null,V(s.chessStore.members,o=>(y(),k("div",{key:o.memberId,class:"member-row flex items-center justify-between rounded-lg px-2.5 py-2"},[u("div",Ho,[u("div",Jo,[G($(o.userId===s.chessStore.myUserId?"我":o.username)+" ",1),o.isOwner?(y(),k("span",Qo,"(Owner)")):K("",!0)]),u("div",Go,$(o.role==="white"?"白方":"黑方"),1)]),s.chessStore.isOwner&&!o.isOwner?(y(),k("button",{key:0,class:"px-2.5 py-1.5 rounded-lg text-xs font-medium",style:{color:"var(--danger)",background:"var(--danger-subtle)"},onClick:d=>s.chessStore.confirmKickMember(o)}," 移除 ",8,Vo)):K("",!0)]))),128))])])])):K("",!0),s.chessStore.showPromotion?(y(),k("div",Wo,[u("div",{class:"absolute inset-0 bg-black/30",onClick:e[21]||(e[21]=o=>{s.chessStore.showPromotion=!1,s.chessStore.promotionFrom="",s.chessStore.promotionTo=""})}),u("div",zo,[e[42]||(e[42]=u("h3",{class:"text-lg font-semibold mb-2",style:{color:"var(--ink-0)","font-family":"var(--font-heading)"}},"选择升变棋子",-1)),u("div",Yo,[(y(!0),k(U,null,V(s.chessStore.promotionPieces,o=>(y(),k("button",{key:o.type,class:"promo-piece rounded-lg border p-2",style:{"border-color":"var(--ink-4)"},onClick:d=>s.chessStore.doPromotion(o.type)},[u("div",Xo,$(o.unicode),1),u("div",er,$(o.name),1)],8,Zo))),128))])])])):K("",!0),M(s.ConfirmModal,{"model-value":s.chessStore.showSwitchJoinConfirm,title:"切换棋局",description:s.chessStore.switchJoinPrompt,"cancel-text":"取消","confirm-text":"继续","onUpdate:modelValue":e[22]||(e[22]=o=>o?s.chessStore.showSwitchJoinConfirm=!0:s.chessStore.cancelSwitchJoin()),onConfirm:e[23]||(e[23]=o=>s.chessStore.confirmSwitchJoin())},null,8,["model-value","description"]),M(s.ConfirmModal,{"model-value":s.chessStore.showRestartConfirm,title:"确认重启棋局?",description:s.chessStore.restartCountdown>0?`请等待 ${s.chessStore.restartCountdown}s 后确认`:"将清空当前局面并重开新局。","cancel-text":"取消","confirm-text":s.chessStore.restartCountdown>0?`${s.chessStore.restartCountdown}s`:"重启",danger:!0,"onUpdate:modelValue":e[24]||(e[24]=o=>o?s.chessStore.showRestartConfirm=!0:s.chessStore.dismissRestart()),onConfirm:e[25]||(e[25]=o=>s.chessStore.executeRestart())},null,8,["model-value","description","confirm-text"]),M(s.ConfirmModal,{"model-value":s.chessStore.showKickConfirm,title:"确认移除玩家?",description:`确定要将 ${s.chessStore.kickTarget?.username||"该玩家"} 从棋局中移除吗？`,"cancel-text":"取消","confirm-text":"移除",danger:!0,"onUpdate:modelValue":e[26]||(e[26]=o=>o?s.chessStore.showKickConfirm=!0:s.chessStore.dismissKickConfirm()),onConfirm:e[27]||(e[27]=o=>s.chessStore.executeKick())},null,8,["model-value","description"]),M(s.ToastHost,{toast:s.chessStore.toast,exiting:s.chessStore.toastExiting},null,8,["toast","exiting"])])}const ar=ne(vo,[["render",tr]]);export{ar as default};
